<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PushMessageHandlerImpl.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">handlers.impl</a> &gt; <span class="el_source">PushMessageHandlerImpl.scala</span></div><h1>PushMessageHandlerImpl.scala</h1><pre class="source lang-java linenums">package handlers.impl

import dao.PushMessageDao
import form.{ ExpressionForm, PushFilterForm, PushMessageForm, PushRuleForm, PushRuleTarget }
import handlers.PushMessageHandler
import io.growing.marketing.common.model.MessagePlatform.MessagePlatform
import io.growing.marketing.common.model._
import io.growing.marketing.common.model.components.{ Caption, Paragraph }
import io.growing.micros.business.model.{ Product, Status }
import io.growing.micros.play.exception.BadRequestException
import io.growing.micros.play.mvc.FutureUtils
import javax.inject.{ Inject, Singleton }
import service.ProductService
import io.growing.micros.utils.conversion.GrowingConversions._
import io.growing.micros.utils.time.DateTimeUtil.{ UTCNow, now }
import model.Statics
import model.context.MessageContext
import utils.{ ConfigParams, ParseUtil }

import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.Future

/**
 * PushMessageHandlerImpl
 *
 * @author damon lin
 *         2019/6/12
 */
@Singleton
<span class="pc" id="L30">class PushMessageHandlerImpl @Inject() (</span>
<span class="fc" id="L31">  configParams: ConfigParams,</span>
<span class="fc" id="L32">  pushMessageDao: PushMessageDao,</span>
<span class="fc" id="L33">  productService: ProductService) extends PushMessageHandler with FutureUtils {</span>

<span class="nc bnc" id="L35" title="All 4 branches missed.">  lazy val captionLimit = configParams.pushMessageCaptionLimit</span>
<span class="nc bnc" id="L36" title="All 4 branches missed.">  lazy val paragraphLimit = configParams.pushMessageParagraphLimit</span>

  /**
   * APP + 微信小程序以 project ai 为单位缓存 rule
   * Web这边以triggerPages来标记
   *
   * @param form
   * @param products
   * @param message
   * @return
   */
  override def buildRulesFromForm(form: PushMessageForm, products: Seq[Product], message: PushMessage): Seq[PushRule] = {
<span class="nc bnc" id="L48" title="All 2 branches missed.">    val activatedAtMills = if (form.isActivate) Option(UTCNow.getMillis) else None</span>
<span class="nc" id="L49">    form.rule match {</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">      case None ⇒ Seq.empty</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">      case Some(ruleForm) ⇒</span>
        // js 弹窗只需要一条规则
<span class="nc bnc" id="L53" title="All 6 branches missed.">        if (form.platform == MessagePlatform.Web) {</span>
<span class="nc" id="L54">          val maybeTarget = buildRuleTargetFromContentTarget(form.getPushContentTarget)</span>
<span class="nc" id="L55">          Seq(ruleForm.copy(activatedAt = activatedAtMills).toPushRule(message, targets = maybeTarget))</span>
        } else {
          // 查找产品对应的跳转规则 兼容推送和 App 弹窗
<span class="nc" id="L58">          products match {</span>
<span class="nc bnc" id="L59" title="All 6 branches missed.">            case Seq() =&gt; Seq(ruleForm.copy(activatedAt = activatedAtMills).toPushRule(message))</span>
<span class="nc" id="L60">            case _ =&gt; products.map { product =&gt;</span>
<span class="nc" id="L61">              val maybeTarget = form.`type` match {</span>
                /*只有push类型先用前端传过来的targets,没有再自己构造，其他类型忽略前端传过来的target,直接从content里解析，
                因为前端传过来的targets是从后端拿的，如果用了的话会导致一直无法从content中解析出来更新最新的target*/
<span class="nc bnc" id="L64" title="All 8 branches missed.">                case MessageType.push =&gt; ruleForm.targets.flatMap(ts =&gt; ts.find(_.productId.toId == product.dbid))</span>
<span class="nc" id="L65">                  .orElse(buildRuleTargetFromContentTarget(form.getPushContentTarget))</span>
<span class="nc bnc" id="L66" title="All 8 branches missed.">                case MessageType.banner =&gt; ruleForm.targets.flatMap(ts =&gt; ts.find(_.productId.toId == product.dbid))</span>
<span class="nc" id="L67">                case _ =&gt; buildRuleTargetFromContentTarget(form.getPushContentTarget)</span>
              }
<span class="nc" id="L69">              ruleForm.copy(activatedAt = activatedAtMills).toPushRule(message, Some(product), maybeTarget)</span>
            }
          }
        }
    }
  }

  override def buildRuleTargetFromContentTarget(links: Seq[String]): Option[PushRuleTarget] = {
<span class="nc" id="L77">    links.headOption.flatMap { link =&gt;</span>
<span class="nc" id="L78">      val ruleType = link match {</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        case s if s.startsWith(Statics.Protocol.GINAPP) =&gt; &quot;openUrl&quot;</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">        case s if s.startsWith(Statics.Protocol.HTTP) || s.startsWith(Statics.Protocol.HTTPS) =&gt; &quot;openH5&quot;</span>
<span class="nc" id="L81">        case _ =&gt; &quot;custom&quot;</span>
      }
<span class="nc" id="L83">      Some(PushRuleTarget(null, ruleType, link, ParseUtil.parseUrlParameters(link)))</span>
    }
  }

  override def getProductsFromRuleForm(projectId: Int, ruleForm: PushRuleForm, platform: MessagePlatform): Future[Seq[Product]] =
    for {
<span class="nc" id="L89">      products &lt;- ruleForm.productIds match {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        case None ⇒ Future.successful(Seq.empty)</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        case Some(products) ⇒ productService.findByIds(projectId, products.map(_.toId))</span>
      }
<span class="nc" id="L93">      _ ← failCondition(products.exists(p ⇒ MessagePlatform.notWithIn(p.platform, platform)), BadRequestException(&quot;不能包含不同类型的产品&quot;))</span>
<span class="nc" id="L94">    } yield products</span>

  override def validateMessageRunnable(pushMessageForm: PushMessageForm): Either[String, Boolean] = {
    // 如果信息状态从 draft或stop -&gt; activated，校验PushMessage和PushRule中关键字段的完整性
    // 上线时间只取第一次由draft -&gt; activated 的时间
<span class="nc" id="L99">    val intoActivated = pushMessageForm.isActivate</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">    lazy val isComplete = if (pushMessageForm.rule.isEmpty) false else pushMessageForm.isCompleted &amp;&amp; pushMessageForm.rule.get.isCompleted</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">    lazy val isPush = if (MessageType.push == pushMessageForm.`type`) true else false</span>
<span class="nc" id="L102">    val outBoundField = getOutBoundField(pushMessageForm)</span>
<span class="nc bnc" id="L103" title="All 4 branches missed.">    if (outBoundField.nonEmpty &amp;&amp; isPush) {</span>
<span class="nc" id="L104">      Left(s&quot;消息越界,以下字段越界: ${outBoundField.mkString(&quot;、&quot;)}&quot;)</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">    } else if (intoActivated &amp;&amp; !isComplete) {</span>
      val lackRuleFields =
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (pushMessageForm.rule.isEmpty) {</span>
<span class="nc" id="L108">          pushMessageForm.lackFields</span>
        } else {
<span class="nc" id="L110">          pushMessageForm.lackFields ::: pushMessageForm.rule.get.lackField</span>
        }
<span class="nc" id="L112">      Left(s&quot;消息不完整,缺少以下字段: ${lackRuleFields.mkString(&quot;、&quot;)}&quot;)</span>
    } else {
<span class="nc" id="L114">      Right(true)</span>
    }
  }

  override def diffRules(message: BaseMessage, newRules: Seq[PushRule], oldRules: Seq[PushRule]): (RULES, RULES, RULES) = {
<span class="nc bnc" id="L119" title="All 6 branches missed.">    if (message.platform == MessagePlatform.Web) {</span>
<span class="nc" id="L120">      (oldRules, newRules, Seq()) // web 弹窗只有一条 rule 为了简化逻辑 先删除后插入</span>
    } else {
      // 过滤出新规则不包含的产品ID，进行删除
<span class="nc bnc" id="L123" title="All 8 branches missed.">      val needDeleted = oldRules.filter(r =&gt; !newRules.exists(nr =&gt; nr.productId == r.productId))</span>
      // 新规则分组（分组规则为之前有的为 needUpdated， 之前没有的为 needInserted）
<span class="nc bnc" id="L125" title="All 10 branches missed.">      val (needInserted, needUpdated) = newRules.partition(nr =&gt; !oldRules.exists(or =&gt; or.productId == nr.productId))</span>
<span class="nc" id="L126">      (needDeleted, needInserted, needUpdated)</span>
    }
  }

  override def calState(pushMessage: PushMessage, rulesToCreate: Seq[PushRule], rulesToUpdate: Seq[PushRule]): PushMessage = {

    def isPlanning(r: PushRule): Boolean = {
<span class="nc bnc" id="L133" title="All 8 branches missed.">      UTCNow.isBefore(r.startAt) &amp;&amp; pushMessage.state == Status.activated</span>
    }

<span class="nc" id="L136">    val newRulesHasPlanning = rulesToCreate.exists(isPlanning)</span>
<span class="nc" id="L137">    val updatedRulesHasPlanning = rulesToUpdate.exists(isPlanning)</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">    val newState = if (newRulesHasPlanning || updatedRulesHasPlanning) Status.planning else pushMessage.state</span>
<span class="nc" id="L139">    pushMessage.copy(state = newState)</span>
  }

  override def copyNewMessage(userId: Int, message: PushMessage, f: PushMessageForm, maybeURL: Option[String],
    maybePushMetrics: Option[PushMetrics], filter: PushFilter): PushMessage = {
<span class="nc" id="L144">    Some(</span>
<span class="nc" id="L145">      message.copy(</span>
<span class="nc" id="L146">        name = f.name,</span>
<span class="nc" id="L147">        updaterId = userId,</span>
<span class="nc" id="L148">        state = f.state.getOrElse(message.state),</span>
<span class="nc" id="L149">        updatedAt = UTCNow,</span>
<span class="nc" id="L150">        audienceId = f.audienceId,</span>
<span class="nc" id="L151">        audienceType = f.audienceType,</span>
<span class="nc" id="L152">        contentMetadata = f.content,</span>
<span class="nc" id="L153">        contentUrl = maybeURL,</span>
<span class="nc" id="L154">        audienceFilter = filter)).map { m ⇒</span>
<span class="nc" id="L155">        maybePushMetrics.map { pushMetrics ⇒</span>
<span class="nc" id="L156">          m.copy(metricsRef = pushMetrics.dbid)</span>
<span class="nc" id="L157">        }.getOrElse(m)</span>
      }.get
  }

  override def adjustMsgForm(messageForm: PushMessageForm): PushMessageForm = {
<span class="nc" id="L162">    val ruleForm = messageForm.rule.get</span>
<span class="nc" id="L163">    val status = messageForm.state</span>
<span class="nc" id="L164">    val isLoopPush = ruleForm.scheduleAt.isDefined</span>
<span class="nc" id="L165">    val startOfDay = UTCNow.withTimeAtStartOfDay.getMillis</span>
<span class="nc" id="L166">    val endOfDay = UTCNow.plusDays(1).withTimeAtStartOfDay.getMillis</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">    lazy val defaultStartAt = 946656000000L // 2000-1-1 0:00</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">    lazy val defaultEndAt = 4102444800000L // 2100-1-1 8:00</span>
<span class="nc" id="L169">    val startAt = ruleForm.startAt.getOrElse(defaultStartAt)</span>
<span class="nc" id="L170">    val endAt = ruleForm.endAt.getOrElse(defaultEndAt)</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">    val isToday = startAt &gt; startOfDay &amp;&amp; startAt &lt; endOfDay</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">    val afterToday = startAt &gt;= endOfDay</span>
<span class="nc" id="L173">    val secondOfDay = now.secondOfDay.get</span>
    /*
      1.一次性推送,开始时间大于当前时间,状态为activated,将状态修正为planning
      2.一次性推送,结束时间大于当前时间,状态为planning,将状态修正为activated
      3.循环推送,开始日期为创建当天,每日推送时间点大于创建时当天时间点,将状态从activated修正为planning
      4.循环推送,开始日期大于创建当天,将状态从activated修正为planning
     */
<span class="nc bnc" id="L180" title="All 6 branches missed.">    if (!isLoopPush &amp;&amp; startAt &gt; UTCNow.getMillis &amp;&amp; status.contains(Status.activated)) {</span>
<span class="nc" id="L181">      messageForm.copy(state = Some(Status.planning))</span>
<span class="nc bnc" id="L182" title="All 6 branches missed.">    } else if (!isLoopPush &amp;&amp; endAt &gt; UTCNow.getMillis &amp;&amp; status.contains(Status.planning)) {</span>
<span class="nc" id="L183">      messageForm.copy(state = Some(Status.activated))</span>
<span class="nc bnc" id="L184" title="All 8 branches missed.">    } else if (isLoopPush &amp;&amp; isToday &amp;&amp; ruleForm.scheduleAt.get &gt; secondOfDay &amp;&amp; status.contains(Status.activated)) {</span>
<span class="nc" id="L185">      messageForm.copy(state = Some(Status.planning))</span>
<span class="nc bnc" id="L186" title="All 6 branches missed.">    } else if (isLoopPush &amp;&amp; afterToday &amp;&amp; status.contains(Status.activated)) {</span>
<span class="nc" id="L187">      messageForm.copy(state = Some(Status.planning))</span>
    } else {
<span class="nc" id="L189">      messageForm</span>
    }
  }

  override def determineTimeLegality(messageForm: PushMessageForm): Future[Unit] = {
<span class="nc" id="L194">    val ruleForm = messageForm.rule.get</span>
<span class="nc" id="L195">    val oneTimeSend = ruleForm.scheduleAt.isEmpty</span>
<span class="nc" id="L196">    val status = messageForm.state.get</span>
<span class="nc" id="L197">    val startAt = ruleForm.startAt.getOrElse(0L)</span>
<span class="nc" id="L198">    val endAt = ruleForm.endAt.getOrElse(0L)</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">    val startAtErr = startAt &lt; UTCNow.getMillis</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">    val endAtErr = endAt &lt; UTCNow.getMillis</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">    val startEndErr = endAt &lt;= startAt</span>
    // 一次性发送的弹窗或推送才有开始时间的限制,循环发送的推送没有
<span class="nc bnc" id="L203" title="All 10 branches missed.">    if (status == Status.planning &amp;&amp; oneTimeSend &amp;&amp; startAtErr) {</span>
<span class="nc" id="L204">      failCondition(startAtErr, BadRequestException(&quot;开始时间不能小于当前时间&quot;))</span>
<span class="nc bnc" id="L205" title="All 8 branches missed.">    } else if (status == Status.planning &amp;&amp; endAtErr) {</span>
<span class="nc" id="L206">      failCondition(endAtErr, BadRequestException(&quot;结束时间不能小于当前时间&quot;))</span>
<span class="nc bnc" id="L207" title="All 8 branches missed.">    } else if (status == Status.planning &amp;&amp; startEndErr) {</span>
<span class="nc" id="L208">      failCondition(startEndErr, BadRequestException(&quot;开始时间不能大于等于结束时间&quot;))</span>
    } else {
<span class="nc" id="L210">      Future.successful(())</span>
    }
  }

<span class="nc" id="L214">  override def convertFormToFilter(form: Option[PushFilterForm]): PushFilter = form match {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">    case Some(f) =&gt;</span>
<span class="nc" id="L216">      val aux = f.op.split(&quot; &quot;) // 如果用户只选了属性过滤的与或逻辑运算, 前端传a &amp;&amp;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">      val op = if (aux.length == 2) Some(aux(1)) else None</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">      val expr = if (op.isDefined) aux(0) else f.op</span>
<span class="nc" id="L219">      val exprs = f.exprsForms.map { e =&gt;</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">        val op = if (e.op.equals(&quot;=&quot;)) &quot;==&quot; else e.op</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">        val values = if (e.value.isEmpty || e.value.getOrElse(&quot;&quot;).equals(&quot;&quot;)) {</span>
<span class="nc" id="L222">          Some(e.values)</span>
        } else {
<span class="nc" id="L224">          Some(e.value.get.split(&quot;,&quot;).toSeq)</span>
        }
<span class="nc" id="L226">        Expression(e.symbol, e.`type`, e.key, op, e.valueType, None, values)</span>
      }
<span class="nc" id="L228">      PushFilter(</span>
<span class="nc" id="L229">        op,</span>
<span class="nc" id="L230">        expr,</span>
<span class="nc" id="L231">        exprs)</span>
<span class="nc" id="L232">    case _ =&gt; PushFilter(None, &quot;&quot;, Seq())</span>
  }

  override def convertFilterToForm(filter: PushFilter): Option[PushFilterForm] = {
<span class="nc bnc" id="L236" title="All 2 branches missed.">    if (filter.exprs.isEmpty) {</span>
<span class="nc" id="L237">      None</span>
    } else {
<span class="nc" id="L239">      val expr = filter.op.fold(filter.expr)(filter.expr + &quot; &quot; + _)</span>
<span class="nc" id="L240">      val exprsForms = filter.exprs.map { e =&gt;</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        val op = if (e.op.equals(&quot;==&quot;)) &quot;=&quot; else e.op</span>
<span class="nc" id="L242">        val values = e.value.fold(e.values)(v =&gt; Some(v.split(&quot;,&quot;).toSeq))</span>
<span class="nc" id="L243">        ExpressionForm(e.symbol, e.`type`, e.key, op, e.valueType, None, values.getOrElse(Seq.empty))</span>
      }
<span class="nc" id="L245">      Some(</span>
<span class="nc" id="L246">        PushFilterForm(</span>
<span class="nc" id="L247">          expr,</span>
<span class="nc" id="L248">          exprsForms))</span>
    }
  }

  override def validatePushState(context: MessageContext, messageId: Int, expectState: Status.Value): Future[Unit] = {
<span class="nc" id="L253">    context.form match {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">      case form: PushMessageForm =&gt;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (MessageType.push.equals(form.`type`)) {</span>
<span class="nc" id="L256">          pushMessageDao.findById(messageId, context.project.dbid).map {</span>
<span class="nc bnc" id="L257" title="All 8 branches missed.">            case Some(message) if message.state == expectState =&gt; throw BadRequestException(s&quot;推送任务已完成，无法修改&quot;)</span>
            // 找不到的情况交给下面的逻辑判空
<span class="nc" id="L259">            case _ =&gt; Unit</span>
          }
<span class="nc" id="L261">        } else Future.successful(Unit)</span>
<span class="nc" id="L262">      case _ =&gt; Future.successful(Unit)</span>
    }

  }

<span class="nc" id="L267">  def findDuplicatedName(name: String, projectId: Int, id: Option[Int] = None): Future[Unit] = {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">    if (id.isEmpty) {</span>
<span class="nc" id="L269">      pushMessageDao.findByName(name, projectId).flatMap { msgOpt =&gt;</span>
<span class="nc" id="L270">        failCondition(msgOpt.nonEmpty, BadRequestException(s&quot;$name 已存在,请更换名字&quot;))</span>
      }
    } else {
<span class="nc" id="L273">      pushMessageDao.findByNameInOthers(id.get, name, projectId).flatMap { msgOpt =&gt;</span>
<span class="nc" id="L274">        failCondition(msgOpt.nonEmpty, BadRequestException(s&quot;$name 已存在,请更换名字&quot;))</span>
      }
    }
  }

  private def getOutBoundField(pushMessageForm: PushMessageForm): List[String] = {
<span class="nc" id="L280">    val contentMap = pushMessageForm.content.fold(Map.empty[String, String]) {</span>
<span class="nc" id="L281">      e =&gt;</span>
<span class="nc" id="L282">        e.components.collect {</span>
<span class="nc bnc" id="L283" title="All 4 branches missed.">          case paragraph: Paragraph =&gt;</span>
<span class="nc" id="L284">            &quot;paragraph&quot; -&gt; paragraph.config.text</span>
<span class="nc bnc" id="L285" title="All 4 branches missed.">          case caption: Caption =&gt;</span>
<span class="nc" id="L286">            &quot;caption&quot; -&gt; caption.config.text</span>
<span class="nc" id="L287">        }.toMap</span>
    }
<span class="nc bnc" id="L289" title="All 10 branches missed.">    contentMap.collect {</span>
<span class="nc bnc" id="L290" title="All 8 branches missed.">      case (k @ &quot;caption&quot;, v) if v.length &gt; captionLimit =&gt; k + &quot; 不能超过 &quot; + captionLimit + &quot; 字符&quot;</span>
<span class="nc bnc" id="L291" title="All 8 branches missed.">      case (k @ &quot;paragraph&quot;, v) if v.length &gt; paragraphLimit =&gt; k + &quot; 不能超过 &quot; + paragraphLimit + &quot; 字符&quot;</span>
    }.toList
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
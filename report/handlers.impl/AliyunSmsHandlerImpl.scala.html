<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AliyunSmsHandlerImpl.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">handlers.impl</a> &gt; <span class="el_source">AliyunSmsHandlerImpl.scala</span></div><h1>AliyunSmsHandlerImpl.scala</h1><pre class="source lang-java linenums">package handlers.impl

import com.aliyuncs.http.MethodType
import com.aliyuncs.profile.DefaultProfile
import com.aliyuncs.{ CommonRequest, DefaultAcsClient }
import com.google.gson.{ Gson, JsonObject, JsonParser }
import com.typesafe.scalalogging.LazyLogging
import handlers.AliyunSmsHandler
import io.growing.marketing.common.model.{ ShortMessage, SmsConfig }
import javax.inject.{ Inject, Singleton }

import scala.collection.JavaConverters._
import scala.util.Try

@Singleton
<span class="pc bnc" id="L16" title="All 4 branches missed.">class AliyunSmsHandlerImpl @Inject() extends AliyunSmsHandler with LazyLogging {</span>

  override def queryTemplate(templateCode: String, config: SmsConfig): Either[String, String] = {
<span class="nc" id="L19">    val request = buildRequest</span>
<span class="nc" id="L20">    request.setMethod(MethodType.GET)</span>
<span class="nc" id="L21">    request.setAction(&quot;QuerySmsTemplate&quot;)</span>
<span class="nc" id="L22">    request.putQueryParameter(&quot;TemplateCode&quot;, templateCode)</span>
<span class="nc" id="L23">    getResult(buildResponse(config, request), Some(&quot;TemplateContent&quot;))</span>
  }

  override def querySignName(signName: String, config: SmsConfig): Either[String, String] = {
<span class="nc" id="L27">    val request = buildRequest</span>
<span class="nc" id="L28">    request.setMethod(MethodType.GET)</span>
<span class="nc" id="L29">    request.setAction(&quot;QuerySmsSignName&quot;)</span>
<span class="nc" id="L30">    request.putQueryParameter(&quot;SignName&quot;, signName)</span>
<span class="nc" id="L31">    getResult(buildResponse(config, request), Some(&quot;SignName&quot;))</span>
  }

  override def sendSingleMessage(shortMsg: ShortMessage, phoneNum: String, config: SmsConfig): Either[String, String] = {
<span class="nc" id="L35">    val request = buildRequest</span>
<span class="nc" id="L36">    val templateParams = shortMsg.templateParams</span>
<span class="nc" id="L37">    val testValue = shortMsg.testValues</span>
    // params为json格式字符串: {&quot;param1&quot;:&quot;value1&quot;,&quot;param2&quot;:&quot;value2&quot;}
<span class="nc" id="L39">    val params = new Gson().toJson(templateParams.map(_.replaceAll(&quot;[{}]&quot;, &quot;&quot;)).zip(testValue).toMap.asJava)</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">    logger.info(s&quot;Details of sending single short message: templateParams: ${templateParams.mkString(&quot;,&quot;)} params: $params&quot;)</span>
<span class="nc" id="L41">    request.setMethod(MethodType.POST)</span>
<span class="nc" id="L42">    request.setAction(&quot;SendSms&quot;)</span>
<span class="nc" id="L43">    request.putQueryParameter(&quot;PhoneNumbers&quot;, phoneNum)</span>
<span class="nc" id="L44">    request.putQueryParameter(&quot;SignName&quot;, shortMsg.signName.getOrElse(&quot;&quot;))</span>
<span class="nc" id="L45">    request.putQueryParameter(&quot;TemplateCode&quot;, shortMsg.templateCode.getOrElse(&quot;&quot;))</span>
<span class="nc" id="L46">    request.putQueryParameter(&quot;TemplateParam&quot;, params)</span>
<span class="nc" id="L47">    getResult(buildResponse(config, request))</span>
  }

  private def buildRequest = {
<span class="nc" id="L51">    val request = new CommonRequest</span>
<span class="nc" id="L52">    request.setDomain(&quot;dysmsapi.aliyuncs.com&quot;)</span>
<span class="nc" id="L53">    request.setVersion(&quot;2017-05-25&quot;)</span>
<span class="nc" id="L54">    request</span>
  }

  private def buildResponse(config: SmsConfig, request: CommonRequest): JsonObject = {
<span class="nc" id="L58">    val profile = DefaultProfile.getProfile(&quot;default&quot;, config.providerKey, config.providerValue.get)</span>
<span class="nc" id="L59">    Try {</span>
<span class="nc" id="L60">      val r = new DefaultAcsClient(profile).getCommonResponse(request)</span>
<span class="nc" id="L61">      new JsonParser().parse(r.getData).getAsJsonObject</span>
<span class="nc" id="L62">    }.getOrElse {</span>
<span class="nc" id="L63">      val json = new JsonObject</span>
<span class="nc" id="L64">      json.addProperty(&quot;Message&quot;, &quot;请检查AccessKey,模板code等内容&quot;)</span>
<span class="nc" id="L65">      json</span>
    }
  }

<span class="nc" id="L69">  private def getResult(response: JsonObject, param: Option[String] = None) = {</span>
<span class="nc" id="L70">    val message = response.get(&quot;Message&quot;).getAsString</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">    if (message.equals(&quot;OK&quot;)) {</span>
<span class="nc" id="L72">      Right(response.get(param.getOrElse(&quot;Message&quot;)).getAsString)</span>
    } else {
<span class="nc" id="L74">      Left(message)</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthenticationDao.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">dao</a> &gt; <span class="el_source">AuthenticationDao.scala</span></div><h1>AuthenticationDao.scala</h1><pre class="source lang-java linenums">package dao

import io.growing.micros.play.slickpg.GrowingPostgresDriver
import javax.inject.Inject
import org.joda.time.DateTime
import play.api.db.slick.{ DatabaseConfigProvider, HasDatabaseConfigProvider }
import slick.lifted.{ ProvenShape, Rep, TableQuery, Tag }
import io.growing.micros.play.slickpg.GrowingPostgresDriver.api._
import model.auth.Authentication

import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.Future

<span class="nc" id="L14">class AuthenticationTable(tag: Tag) extends BaseTable[Authentication](tag, &quot;authentications&quot;) {</span>

<span class="nc" id="L16">  def key: Rep[String] = column[String](&quot;key&quot;)</span>

<span class="nc" id="L18">  def userId: Rep[Option[Int]] = column[Option[Int]](&quot;user_id&quot;)</span>

<span class="nc" id="L20">  def provider: Rep[String] = column[String](&quot;provider&quot;)</span>

<span class="nc" id="L22">  def uid: Rep[String] = column[String](&quot;uid&quot;)</span>

<span class="nc" id="L24">  def email: Rep[Option[String]] = column[Option[String]](&quot;email&quot;)</span>

<span class="nc" id="L26">  def token: Rep[String] = column[String](&quot;token&quot;)</span>

<span class="nc" id="L28">  override def * : ProvenShape[Authentication] = (id.?, key, userId, provider, uid, email, token, createdAt, updatedAt) &lt;&gt; ((Authentication.apply _).tupled, Authentication.unapply)</span>
}

<span class="nc" id="L31">class AuthenticationDao @Inject() (override protected val dbConfigProvider: DatabaseConfigProvider)</span>
<span class="nc" id="L32">  extends BaseDao[AuthenticationTable, Authentication] with HasDatabaseConfigProvider[GrowingPostgresDriver] {</span>

<span class="nc" id="L34">  override val table = TableQuery[AuthenticationTable]</span>
<span class="nc" id="L35">  val authentications = table</span>

<span class="nc" id="L37">  val byToken = authentications.findBy(_.token)</span>

  def createOrUpdate(authentication: Authentication): Future[Int] = {
<span class="nc" id="L40">    db.run(authentications.filter(x =&gt; x.provider === authentication.provider &amp;&amp; x.uid === authentication.uid)</span>
<span class="nc" id="L41">      .result.headOption) flatMap {</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">      case Some(auth) =&gt; update(authentication.copy(id = auth.id, updatedAt = DateTime.now()))</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">      case None =&gt; create(authentication)</span>
    }
  }

  def create(authentication: Authentication): Future[Int] = {
<span class="nc" id="L48">    db.run(authentications returning authentications.map(_.id) += authentication)</span>
  }

  def update(authentication: Authentication): Future[Int] = {
<span class="nc" id="L52">    db.run(authentications.filter(x =&gt; x.provider === authentication.provider &amp;&amp; x.uid === authentication.uid)</span>
<span class="nc" id="L53">      .map(x =&gt; (x.userId, x.token, x.updatedAt)).update((authentication.userId, authentication.token, authentication.updatedAt)))</span>
  }

  def destroy(authenticationId: Int) = {
<span class="nc" id="L57">    db.run(authentications.filter(_.id === authenticationId).delete)</span>
  }

  def findByAuth(auth: String): Future[Option[Authentication]] = {
<span class="nc" id="L61">    db.run(byToken(auth).result.headOption)</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
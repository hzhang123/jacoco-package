<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WeChatClient.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">client</a> &gt; <span class="el_source">WeChatClient.scala</span></div><h1>WeChatClient.scala</h1><pre class="source lang-java linenums">package client

import akka.util.ByteString
import exception.{ WechatAppIdInvalidException, WechatAppSecretInvalidException, WechatInvalidTokenException, WechatTokenSystemBusyException }
import javax.inject.Inject
import play.api.libs.json.Json
import play.api.libs.ws.WSClient
import javax.inject.Singleton

import scala.concurrent.{ ExecutionContext, Future }
import scala.concurrent.duration._

@Singleton
<span class="nc" id="L14">class WeChatClient @Inject() (ws: WSClient)(implicit ec: ExecutionContext) {</span>

  def getAccessToken(appid: String, secret: String): Future[String] = {
<span class="nc" id="L17">    ws.url(&quot;https://api.weixin.qq.com/cgi-bin/token&quot;)</span>
<span class="nc" id="L18">      .addQueryStringParameters(</span>
<span class="nc" id="L19">        &quot;grant_type&quot; -&gt; &quot;client_credential&quot;,</span>
<span class="nc" id="L20">        &quot;appid&quot; -&gt; appid,</span>
<span class="nc" id="L21">        &quot;secret&quot; -&gt; secret)</span>
<span class="nc" id="L22">      .withRequestTimeout(1000.millis).get().map {</span>
<span class="nc bnc" id="L23" title="All 4 branches missed.">        case response if response.status == 200 &amp;&amp; response.body.contains(&quot;access_token&quot;) =&gt;</span>
<span class="nc" id="L24">          (response.json \ &quot;access_token&quot;).as[String]</span>
<span class="nc bnc" id="L25" title="All 2 branches missed.">        case response if response.body.contains(&quot;errcode&quot;) =&gt;</span>
<span class="nc" id="L26">          val errcode = (response.json \ &quot;errcode&quot;).as[Int]</span>
<span class="nc bnc" id="L27" title="All 4 branches missed.">          errcode match {</span>
<span class="nc" id="L28">            case -1 =&gt; throw WechatTokenSystemBusyException(response);</span>
<span class="nc" id="L29">            case 40125 =&gt; throw WechatAppSecretInvalidException(response);</span>
<span class="nc" id="L30">            case 40013 =&gt; throw WechatAppIdInvalidException(response);</span>
<span class="nc" id="L31">            case _ =&gt; throw new IllegalAccessException(response.body);</span>
          }
<span class="nc" id="L33">        case response =&gt; throw new IllegalAccessException(response.body);</span>
      }
  }

  def getQrCodeImage(accessToken: String, scene: String): Future[ByteString] = {
<span class="nc" id="L38">    ws.url(&quot;https://api.weixin.qq.com/wxa/getwxacodeunlimit&quot;)</span>
<span class="nc" id="L39">      .addQueryStringParameters(&quot;access_token&quot; -&gt; accessToken)</span>
<span class="nc" id="L40">      .withRequestTimeout(3000.millis).post(Json.obj(&quot;scene&quot; -&gt; scene)).map {</span>
<span class="nc bnc" id="L41" title="All 4 branches missed.">        case response if response.status == 200 &amp;&amp; response.contentType.contains(&quot;image&quot;) =&gt; response.bodyAsBytes</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">        case response if response.body.contains(&quot;errcode&quot;) =&gt;</span>
<span class="nc" id="L43">          val errcode = (response.json \ &quot;errcode&quot;).as[Int]</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">          errcode match {</span>
<span class="nc" id="L45">            case 40001 =&gt; throw WechatInvalidTokenException(response);</span>
<span class="nc" id="L46">            case _ =&gt; throw new IllegalAccessException(response.body);</span>
          }
<span class="nc" id="L48">        case response =&gt; throw new IllegalAccessException(response.body)</span>
      }
  }
<span class="nc" id="L51">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InAppMessageAPIForm.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">form.api</a> &gt; <span class="el_source">InAppMessageAPIForm.scala</span></div><h1>InAppMessageAPIForm.scala</h1><pre class="source lang-java linenums">package form.api

import form.PushMessageForm.nameRegex
import play.api.libs.json.Reads.min
import play.api.libs.functional.syntax._
import play.api.libs.json.Reads.{ filter, _ }
import io.growing.micros.utils.time.DateTimeUtil.UTCNow
import play.api.libs.json.{ JsPath, JsonValidationError, Reads }
import form.{ PushMessageForm, PushRuleForm, PushRuleTarget }
import io.growing.marketing.common.model.AudienceType.AudienceType
import io.growing.marketing.common.model._
import io.growing.micros.business.model.Status
import io.growing.micros.business.model.Status.Status

/**
 * InAppMessageAPIForm
 *
 * @author damon lin
 *         2019/8/15
 */
<span class="nc bnc" id="L21" title="All 48 branches missed.">case class InAppMessageAPIForm(</span>
<span class="nc" id="L22">  name: String,</span>
<span class="nc" id="L23">  audience: String,</span>
<span class="nc" id="L24">  rule: InAppMessageAPIRuleForm,</span>
<span class="nc" id="L25">  content: String,</span>
<span class="nc" id="L26">  state: Option[Status]) extends APIForm {</span>

  def convertToPushMessageForm(
    audienceType: Option[AudienceType],
    realAudienceId: Option[String],
    realContent: PushContent): PushMessageForm = {
<span class="nc" id="L32">    val ruleForm = rule.toPushRuleForm</span>
<span class="nc" id="L33">    PushMessageForm(</span>
<span class="nc" id="L34">      name,</span>
<span class="nc" id="L35">      `type` = MessageType.popupWindow,</span>
<span class="nc" id="L36">      state.orElse(Some(Status.activated)),</span>
<span class="nc" id="L37">      platform = MessagePlatform.App,</span>
<span class="nc" id="L38">      audienceType,</span>
<span class="nc" id="L39">      realAudienceId,</span>
<span class="nc" id="L40">      None,</span>
<span class="nc" id="L41">      None,</span>
<span class="nc" id="L42">      Some(ruleForm),</span>
<span class="nc" id="L43">      Some(realContent),</span>
<span class="nc" id="L44">      None)</span>
  }

}

<span class="nc" id="L49">object InAppMessageAPIForm {</span>

<span class="nc" id="L51">  implicit val reads: Reads[InAppMessageAPIForm] = (</span>
<span class="nc bnc" id="L52" title="All 4 branches missed.">    (JsPath \ &quot;name&quot;).read[String](filter[String](JsonValidationError(&quot;名字不能为空，只支持中英文，数字，下划线，中划线，斜杠，1到25个字符&quot;))(name =&gt; nameRegex.findAllIn(name).isEmpty &amp;&amp; name.length &lt; 100)) and</span>
<span class="nc" id="L53">    (JsPath \ &quot;audience&quot;).read[String] and</span>
<span class="nc" id="L54">    (JsPath \ &quot;rule&quot;).read[InAppMessageAPIRuleForm] and</span>
<span class="nc" id="L55">    (JsPath \ &quot;content&quot;).read[String] and</span>
<span class="nc" id="L56">    (JsPath \ &quot;state&quot;).readNullable[Status])(InAppMessageAPIForm.apply _)</span>
}

<span class="nc bnc" id="L59" title="All 51 branches missed.">case class InAppMessageAPIRuleForm(</span>
<span class="nc" id="L60">  action: String,</span>
<span class="nc" id="L61">  targets: List[PushRuleTarget],</span>
<span class="nc" id="L62">  limit: Int,</span>
<span class="nc" id="L63">  startAt: Option[Long],</span>
<span class="nc" id="L64">  endAt: Option[Long],</span>
<span class="nc" id="L65">  triggerCd: Option[Int]) {</span>

  def toPushRuleForm: PushRuleForm = {
<span class="nc bnc" id="L68" title="All 6 branches missed.">    val ruleType = if (action == &quot;appOpen&quot;) PushRuleType.System else PushRuleType.Custom</span>
<span class="nc" id="L69">    val productIds = Some(targets.map(_.productId))</span>
<span class="nc" id="L70">    PushRuleForm(</span>
<span class="nc" id="L71">      Some(ruleType),</span>
<span class="nc" id="L72">      Some(action),</span>
<span class="nc" id="L73">      Some(TriggerFilter(&quot;&quot;, Seq.empty)),</span>
<span class="nc" id="L74">      Some(targets),</span>
<span class="nc" id="L75">      Some(limit),</span>
<span class="nc" id="L76">      None,</span>
<span class="nc" id="L77">      activatedAt = Some(UTCNow.getMillis),</span>
<span class="nc" id="L78">      startAt,</span>
<span class="nc" id="L79">      endAt,</span>
<span class="nc" id="L80">      None,</span>
<span class="nc" id="L81">      triggerCd,</span>
<span class="nc" id="L82">      productIds,</span>
<span class="nc" id="L83">      None)</span>
  }

}

<span class="nc" id="L88">object InAppMessageAPIRuleForm {</span>

<span class="nc" id="L90">  implicit val reads: Reads[InAppMessageAPIRuleForm] = (</span>
<span class="nc" id="L91">    (JsPath \ &quot;action&quot;).read[String] and</span>
<span class="nc" id="L92">    (JsPath \ &quot;targets&quot;).read[List[PushRuleTarget]] and</span>
<span class="nc" id="L93">    (JsPath \ &quot;limit&quot;).read[Int](min(1)) and</span>
<span class="nc" id="L94">    (JsPath \ &quot;startAt&quot;).readNullable[Long] and</span>
<span class="nc" id="L95">    (JsPath \ &quot;endAt&quot;).readNullable[Long] and</span>
<span class="nc" id="L96">    (JsPath \ &quot;triggerCd&quot;).readNullable[Int])(InAppMessageAPIRuleForm.apply _)</span>

<span class="nc" id="L98">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
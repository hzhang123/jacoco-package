<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageMetricsHandler.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">infrastructure.measurement.metrics</a> &gt; <span class="el_source">MessageMetricsHandler.scala</span></div><h1>MessageMetricsHandler.scala</h1><pre class="source lang-java linenums">package infrastructure.measurement.metrics

import com.typesafe.scalalogging.LazyLogging
import dao.PushMetricsDao
import form.{ Attribute, EventLevelVarForm }
import infrastructure.measurement.dimension.DimensionRpcClient
import io.growing.events.protobuf.{ CustomEventDto, EventVariableDto }
import io.growing.marketing.common.model.MessageType.MessageType
import io.growing.marketing.common.model.{ MessageType, PushMetrics }
import io.growing.micros.business.model.Project
import javax.inject.Inject
import model.Statics
import io.growing.micros.utils.conversion.GrowingConversions._

import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.Future

/**
 * MessageMetricsHandler
 *
 * @author damon lin
 *         2019/11/18
 */
<span class="pc bnc" id="L24" title="All 4 branches missed.">class MessageMetricsHandler @Inject() (</span>
<span class="fc" id="L25">  pushMetricsDao: PushMetricsDao,</span>
<span class="fc" id="L26">  dimensionRpcClient: DimensionRpcClient,</span>
<span class="fc" id="L27">  metricsRpcClient: MetricRpcClient) extends LazyLogging {</span>

  def findById(id: Int): Future[Option[PushMetrics]] = {
<span class="nc" id="L30">    pushMetricsDao.findById(id)</span>
  }

  // 查询项目下是否有全局指标
  def findInAppMetricByProject(projectId: Int): Future[Option[PushMetrics]] = {
<span class="nc" id="L35">    pushMetricsDao.findProjectMetrics(projectId)</span>
  }

  // 查询项目下是否有推送消息全局指标
  def findPushMessageMetricByProject(projectId: Int): Future[Option[PushMetrics]] = {
<span class="nc" id="L40">    pushMetricsDao.findProjectPushMessageMetrics(projectId)</span>
  }

  def createMetricsIfNecessary(typ: MessageType, project: Project, userId: Int): Future[PushMetrics] = {
<span class="nc" id="L44">    typ match {</span>
<span class="nc bnc" id="L45" title="All 6 branches missed.">      case MessageType.push =&gt;</span>
<span class="nc" id="L46">        createPushMetrics(project, userId)</span>
      case _ =&gt;
<span class="nc" id="L48">        createInAppMetrics(project, userId)</span>
    }
  }

  private[this] def createPushMetrics(project: Project, userId: Int): Future[PushMetrics] = {
<span class="nc" id="L53">    findPushMessageMetricByProject(project.dbid).flatMap {</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">      case Some(metrics) =&gt; Future.successful(metrics)</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">      case None =&gt;</span>
        // 创建访问用户变量 用于上传推送相关信息
<span class="nc" id="L57">        val visitorVars = MetricsBuildHelper.buildPushVisitorVariable()</span>
<span class="nc" id="L58">        dimensionRpcClient.createVisitorVariables(project.dbid, visitorVars)</span>
<span class="nc" id="L59">        val vars = MetricsBuildHelper.buildPushMessageEventLevelVarForm()</span>
        for {
<span class="nc" id="L61">          metrics &lt;- createGlobalMetricsCommon(project, userId, vars, Statics.PUSH_GLOBAL)</span>
<span class="nc" id="L62">          id &lt;- pushMetricsDao.insert(metrics)</span>
<span class="nc" id="L63">        } yield metrics.copy(id = Some(id))</span>
    }
  }

  private[this] def createInAppMetrics(project: Project, userId: Int): Future[PushMetrics] = {
<span class="nc" id="L68">    findInAppMetricByProject(project.dbid).flatMap {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">      case Some(metrics) =&gt; Future.successful(metrics)</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">      case None =&gt;</span>
<span class="nc" id="L71">        val vars = MetricsBuildHelper.buildEventLevelVarForm()</span>
        for {
<span class="nc" id="L73">          metrics &lt;- createGlobalMetricsCommon(project, userId, vars, Statics.GLOBAL)</span>
<span class="nc" id="L74">          id &lt;- pushMetricsDao.insert(metrics)</span>
<span class="nc" id="L75">        } yield metrics.copy(id = Some(id))</span>
    }
  }

  private[this] def createGlobalMetricsCommon(project: Project, userId: Int, eventLevelVarForms: Seq[EventLevelVarForm], metricType: String): Future[PushMetrics] = {

    def buildResult(events: Seq[CustomEventDto]) = {
<span class="nc bnc" id="L82" title="All 6 branches missed.">      val maybeEventVarForm = if (Statics.PUSH_GLOBAL == metricType) {</span>
<span class="nc bnc" id="L83" title="All 6 branches missed.">        eventLevelVarForms.find(_.key == Statics.EVENT_LEVEL_VAR_PUSH_MESSAGE_NAME_KEY)</span>
      } else {
<span class="nc bnc" id="L85" title="All 6 branches missed.">        eventLevelVarForms.find(_.key == Statics.EVENT_LEVEL_VAR_MESSAGE_NAME_KEY)</span>
      }
<span class="nc" id="L87">      Future.successful(buildPushMetrics(events, metricType, project.dbid, maybeEventVarForm))</span>
    }

    def createEvents(eventLevelVars: Seq[EventVariableDto]) = {
<span class="nc" id="L91">      val attributes = eventLevelVars.map(v =&gt; Attribute(v.getId)).toList</span>
<span class="nc" id="L92">      val eventsForm = MetricsBuildHelper.buildEventFormsByType(attributes, metricType)</span>
<span class="nc" id="L93">      metricsRpcClient.createEventsBatch(eventsForm, project.dbid, userId, ignoreQuota = true).flatMap {</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        case Left(error) ⇒</span>
          // fallback
          // 如果指标重复创建 需要查询已有的系统指标
<span class="nc bnc" id="L97" title="All 2 branches missed.">          logger.warn(error)</span>
<span class="nc" id="L98">          metricsRpcClient.queryCustomEvents(eventsForm.map(_.key), project.dbid).flatMap { events =&gt;</span>
<span class="nc" id="L99">            buildResult(events)</span>
          }
<span class="nc bnc" id="L101" title="All 2 branches missed.">        case Right(events) ⇒</span>
<span class="nc" id="L102">          buildResult(events)</span>
      }
    }

<span class="nc" id="L106">    dimensionRpcClient.createEventLevelVars(project.dbid, userId, eventLevelVarForms).flatMap {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">      case eventLevelVars: Seq[EventVariableDto] ⇒</span>
<span class="nc" id="L108">        createEvents(eventLevelVars)</span>
      case _ ⇒
        // fallback
        // 如果重复创建 events 服务会返回老的变量
<span class="nc" id="L112">        Future.failed(new Exception(&quot;事件级变量创建失败&quot;))</span>
    }
  }

  private[this] def buildPushMetrics(events: Seq[CustomEventDto], typ: String, projectId: Int, maybeEventVar: Option[EventLevelVarForm]): PushMetrics = {
    // 组件点击量，或者是推送消息点击
<span class="nc bnc" id="L118" title="All 4 branches missed.">    val ctaEvents = events.filter(event =&gt; event.getKey.contains(&quot;_cmp&quot;) || event.getKey.contains(&quot;_clicked&quot;))</span>
    // 消息浏览量，或者是推送消息送达
<span class="nc bnc" id="L120" title="All 4 branches missed.">    val msgImpEvent = events.find(event =&gt; event.getKey.endsWith(&quot;_imp&quot;) || event.getKey.endsWith(&quot;_arrived&quot;))</span>

<span class="nc" id="L122">    val msgCloseEvent = events.find(_.getKey.endsWith(&quot;_close&quot;)) // 消息关闭量</span>
<span class="nc" id="L123">    val msgSentEvent = events.find(_.getKey.endsWith(&quot;_sent&quot;)) // 消息发送时间</span>

<span class="nc" id="L125">    val eventLevelVar = msgImpEvent.map(_.getAttributes(0))</span>
<span class="nc" id="L126">    val metrics = PushMetrics(</span>
<span class="nc" id="L127">      None,</span>
<span class="nc" id="L128">      ctaEvents.toList.map(_.getId.toId),</span>
<span class="nc" id="L129">      msgImpEvent.map(_.getId.toId),</span>
<span class="nc" id="L130">      msgCloseEvent.map(_.getId.toId),</span>
<span class="nc" id="L131">      None,</span>
<span class="nc" id="L132">      typ,</span>
<span class="nc" id="L133">      maybeEventVar.map(_.name),</span>
<span class="nc" id="L134">      maybeEventVar.map(_.key),</span>
<span class="nc" id="L135">      maybeEventVar.map(_.valueType),</span>
<span class="nc" id="L136">      Some(projectId),</span>
<span class="nc" id="L137">      eventLevelVar.map(_.getId.toId),</span>
<span class="nc" id="L138">      msgSentEvent.map(_.getId.toId))</span>
<span class="nc" id="L139">    metrics</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MarketingEditionDao.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">dao</a> &gt; <span class="el_source">MarketingEditionDao.scala</span></div><h1>MarketingEditionDao.scala</h1><pre class="source lang-java linenums">package dao

import javax.inject.{ Inject, Singleton }
import io.growing.marketing.common.model.EditionStatus.EditionStatus
import io.growing.marketing.common.model.EditionType.EditionType
import slick.lifted.{ TableQuery, Tag }
import io.growing.marketing.common.model.{ EditionStatus, EditionType, MarketingEdition }
import io.growing.micros.play.slickpg.GrowingPostgresDriver
import io.growing.micros.play.slickpg.GrowingPostgresDriver.api._
import io.growing.micros.utils.time.DateTimeUtil
import org.joda.time.DateTime
import play.api.db.slick.{ DatabaseConfigProvider, HasDatabaseConfigProvider }
import scala.concurrent.Future

<span class="fc" id="L15">trait MarketingEditionComponent {</span>
<span class="fc" id="L16">  implicit val EditionStatusE = MappedColumnType.base[EditionStatus, String](</span>
<span class="fc" id="L17">    e =&gt; e.toString,</span>
<span class="pc" id="L18">    s =&gt; EditionStatus.withName(s))</span>

<span class="fc" id="L20">  implicit val EditionTypeE = MappedColumnType.base[EditionType, String](</span>
<span class="fc" id="L21">    e =&gt; e.toString,</span>
<span class="pc" id="L22">    s =&gt; EditionType.withName(s))</span>

<span class="pc bpc" id="L24" title="1 of 2 branches missed.">  class MarketingEditionTable(tag: Tag) extends Table[MarketingEdition](tag, &quot;marketing_editions&quot;) {</span>
<span class="fc" id="L25">    def id = column[Int](&quot;id&quot;, O.PrimaryKey, O.AutoInc)</span>
<span class="fc" id="L26">    def organizationId = column[Int](&quot;organization_id&quot;)</span>
<span class="fc" id="L27">    def status = column[Option[EditionStatus]](&quot;status&quot;)</span>
<span class="fc" id="L28">    def applyAt = column[Option[DateTime]](&quot;apply_at&quot;)</span>
<span class="fc" id="L29">    def expiredAt = column[Option[DateTime]](&quot;expired_at&quot;)</span>
<span class="fc" id="L30">    def typ = column[Option[EditionType]](&quot;type&quot;)</span>
<span class="fc" id="L31">    def createdAt = column[Option[DateTime]](&quot;created_at&quot;)</span>
<span class="fc" id="L32">    def updatedAt = column[Option[DateTime]](&quot;updated_at&quot;)</span>
<span class="fc" id="L33">    def creatorId = column[Int](&quot;creator_id&quot;)</span>
<span class="fc" id="L34">    def updaterId = column[Int](&quot;updater_id&quot;)</span>
<span class="pc" id="L35">    override def * = (id.?, organizationId, status, applyAt, expiredAt, typ, createdAt, updatedAt, creatorId, updaterId) &lt;&gt; ((MarketingEdition.apply _).tupled, MarketingEdition.unapply)</span>
  }
}

@Singleton
<span class="pc bnc" id="L40" title="All 8 branches missed.">class MarketingEditionDao @Inject() (protected val dbConfigProvider: DatabaseConfigProvider)</span>
<span class="fc" id="L41">  extends MarketingEditionComponent with HasDatabaseConfigProvider[GrowingPostgresDriver] { self: HasDatabaseConfigProvider[GrowingPostgresDriver] ⇒</span>
<span class="fc" id="L42">  val marketingEditionTable = TableQuery[MarketingEditionTable]</span>

  def findExpiredTrail: Future[Seq[MarketingEdition]] = {
<span class="fc" id="L45">    db.run(marketingEditionTable.filter(r ⇒ r.expiredAt &lt; DateTimeUtil.UTCNow &amp;&amp; r.status === EditionStatus.Activated &amp;&amp; r.typ === EditionType.Trial).result)</span>
  }

  def findByOrganizationId(organizationId: Int): Future[Option[MarketingEdition]] = {
<span class="nc" id="L49">    db.run(marketingEditionTable.filter(_.organizationId === organizationId).result.headOption)</span>
  }

  def insert(marketingEdition: MarketingEdition): Future[MarketingEdition] = {
<span class="nc" id="L53">    db.run(marketingEditionTable returning marketingEditionTable.map(_.id) into ((payload, id) ⇒ payload.withId(id)) += marketingEdition)</span>
  }

  def update(record: MarketingEdition): Future[Int] = {
<span class="nc" id="L57">    db.run(marketingEditionTable</span>
<span class="nc" id="L58">      .filter(_.id === record.id).update(record))</span>
  }

  def update(records: Seq[MarketingEdition]) = {
<span class="pc" id="L62">    db.run(DBIO.sequence(records.map(r ⇒ marketingEditionTable.filter(_.id === r.id).update(r))))</span>
  }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PushMessageForm.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">form</a> &gt; <span class="el_source">PushMessageForm.scala</span></div><h1>PushMessageForm.scala</h1><pre class="source lang-java linenums">package form

import io.growing.marketing.common.model.AudienceType.AudienceType
import io.growing.marketing.common.model.MessagePlatform.MessagePlatform
import io.growing.marketing.common.model.MessageType.MessageType
import io.growing.marketing.common.model._
import io.growing.micros.business.model.Status
import io.growing.micros.business.model.Status.Status
import play.api.libs.json._
import play.api.libs.json.Reads._
import play.api.libs.functional.syntax._
import io.growing.micros.utils.conversion.GrowingConversions._
import utils.MappingUtil

<span class="nc bnc" id="L15" title="All 88 branches missed.">final case class PushMessageForm(</span>
<span class="nc" id="L16">  name: String,</span>
<span class="nc" id="L17">  `type`: MessageType,</span>
<span class="nc" id="L18">  state: Option[Status],</span>
<span class="nc" id="L19">  platform: MessagePlatform = MessagePlatform.App,</span>
<span class="nc" id="L20">  audienceType: Option[AudienceType],</span>
<span class="nc" id="L21">  audienceId: Option[String],</span>
<span class="nc" id="L22">  campaign: Option[String],</span>
<span class="nc" id="L23">  priority: Option[Int],</span>
<span class="nc" id="L24">  rule: Option[PushRuleForm],</span>
<span class="nc" id="L25">  content: Option[PushContent],</span>
<span class="nc" id="L26">  audienceFilter: Option[PushFilterForm]) extends BaseMessageForm { self =&gt;</span>

  def buildMessage(projectId: Int, ai: String, contentUrl: Option[String], creatorId: Int, updaterId: Int,
    filter: PushFilter): PushMessage = {
<span class="nc bnc" id="L30" title="All 6 branches missed.">    val realSate = if (`type` == MessageType.banner) Status.draft else state.getOrElse(Status.draft)</span>
<span class="nc" id="L31">    PushMessage(</span>
<span class="nc" id="L32">      None,</span>
<span class="nc" id="L33">      self.platform,</span>
<span class="nc" id="L34">      self.name,</span>
<span class="nc" id="L35">      projectId,</span>
<span class="nc" id="L36">      ai,</span>
<span class="nc" id="L37">      realSate, // banner 类型的消息在上线前只有 draft 状态</span>
<span class="nc" id="L38">      `type`,</span>
<span class="nc" id="L39">      priority.getOrElse(PushMessageForm.DefaultPriority),</span>
<span class="nc" id="L40">      contentUrl,</span>
<span class="nc" id="L41">      self.content,</span>
<span class="nc" id="L42">      campaign.map(_.toId).getOrElse(PushMessageForm.DefaultCampaign),</span>
<span class="nc" id="L43">      PushMessageForm.DefaultChannel,</span>
<span class="nc" id="L44">      PushMessageForm.EmptyMetricRef,</span>
<span class="nc" id="L45">      self.audienceType,</span>
<span class="nc" id="L46">      self.audienceId,</span>
<span class="nc" id="L47">      creatorId,</span>
<span class="nc" id="L48">      updaterId,</span>
<span class="nc" id="L49">      filter,</span>
<span class="nc" id="L50">      MsgVersion.v3)</span>
  }

  def isCompleted: Boolean = {
<span class="nc bnc" id="L54" title="All 6 branches missed.">    audienceType.exists(AudienceType.SystemAudienceTypes.contains) || audienceId.isDefined || audienceFilter.isDefined</span>
  }

  def lackFields: List[String] = {
<span class="nc" id="L58">    var lackFields = new scala.collection.mutable.ListBuffer[String]</span>
<span class="nc bnc" id="L59" title="All 6 branches missed.">    if (audienceType.isEmpty &amp;&amp; audienceId.isEmpty &amp;&amp; audienceFilter.isEmpty) {</span>
<span class="nc" id="L60">      lackFields += &quot;用户分群或过滤条件&quot;</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">    } else if (audienceType.exists(AudienceType.SystemAudienceTypes.contains)) {</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">      if (rule.isEmpty)</span>
<span class="nc" id="L63">        lackFields += &quot;推送规则&quot;</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">      if (content.isEmpty)</span>
<span class="nc" id="L65">        lackFields += &quot;推送内容&quot;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">    } else if (!audienceType.exists(AudienceType.SystemAudienceTypes.contains)) {</span>
<span class="nc bnc" id="L67" title="All 4 branches missed.">      if (audienceId.isEmpty &amp;&amp; audienceFilter.isEmpty)</span>
<span class="nc" id="L68">        lackFields += &quot;用户分群或过滤条件&quot;</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">      if (rule.isEmpty)</span>
<span class="nc" id="L70">        lackFields += &quot;推送规则&quot;</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">      if (content.isEmpty)</span>
<span class="nc" id="L72">        lackFields += &quot;推送内容&quot;</span>
    }
<span class="nc" id="L74">    lackFields.toList</span>
  }
}

<span class="nc" id="L78">object PushMessageForm {</span>
<span class="nc" id="L79">  val DefaultPriority = 1</span>
<span class="nc" id="L80">  val DefaultIndex = 0</span>
<span class="nc" id="L81">  val DefaultCampaign = 0</span>
<span class="nc" id="L82">  val DefaultChannel = 1</span>
<span class="nc" id="L83">  val EmptyMetricRef = 1</span>

<span class="nc" id="L85">  val mapping = Map(&quot;uv&quot; -&gt; &quot;u&quot;, &quot;usv&quot; -&gt; &quot;cs1&quot;)</span>
<span class="nc" id="L86">  val nameRegex = &quot;&quot;&quot;[`￥%……&amp;*（）——+|{}【】‘；：”“’。，、？]&quot;&quot;&quot;.r</span>

<span class="nc" id="L88">  implicit val reads: Reads[PushMessageForm] = (</span>
    //todo internationalization
<span class="nc bnc" id="L90" title="All 4 branches missed.">    (JsPath \ &quot;name&quot;).read[String](filter[String](JsonValidationError(&quot;名字不能为空，只支持中英文，数字，下划线，中划线，斜杠，1到25个字符&quot;))(name =&gt; nameRegex.findAllIn(name).isEmpty &amp;&amp; name.length &lt; 100)) and</span>
<span class="nc" id="L91">    (JsPath \ &quot;type&quot;).read[MessageType] and</span>
<span class="nc" id="L92">    (JsPath \ &quot;state&quot;).readNullable[Status] and</span>
<span class="nc" id="L93">    ((JsPath \ &quot;platform&quot;).read[MessagePlatform] or Reads.pure(MessagePlatform.App)) and</span>
<span class="nc" id="L94">    (JsPath \ &quot;audienceType&quot;).readNullable[AudienceType] and</span>
<span class="nc" id="L95">    (JsPath \ &quot;audienceId&quot;).readNullable[String].map(id =&gt; MappingUtil.segmentIdMapping(id, mapping, id =&gt; id.toId.toString)) and</span>
<span class="nc" id="L96">    (JsPath \ &quot;campaign&quot;).readNullable[String] and</span>
<span class="nc" id="L97">    (JsPath \ &quot;priority&quot;).readNullable[Int] and</span>
<span class="nc" id="L98">    (JsPath \ &quot;rule&quot;).readNullable[PushRuleForm] and</span>
<span class="nc" id="L99">    (JsPath \ &quot;content&quot;).readNullable[PushContent] and</span>
<span class="nc" id="L100">    (JsPath \ &quot;audienceFilter&quot;).readNullable[PushFilterForm])(PushMessageForm.apply _)</span>
<span class="nc" id="L101">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
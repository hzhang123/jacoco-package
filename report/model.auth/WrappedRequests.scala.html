<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WrappedRequests.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">model.auth</a> &gt; <span class="el_source">WrappedRequests.scala</span></div><h1>WrappedRequests.scala</h1><pre class="source lang-java linenums">package model.auth

import java.time.ZonedDateTime

import play.api.libs.json.Json
import java.util.{ Locale, TimeZone }
import java.time.format.DateTimeFormatter

import scala.collection.JavaConverters._
import io.growing.micros.business.auth.User
import com.typesafe.scalalogging.LazyLogging
import io.growing.micros.business.model.{ Organization, Project }
import io.growing.micros.utils.IPAddressUtil
import org.joda.time.{ DateTime, DateTimeZone }
import play.api.mvc._
import play.api.mvc.request.RemoteConnection

/**
 * @author wayne
 * @since 16-11-11
 */
<span class="nc bnc" id="L22" title="All 71 branches missed.">final case class AccountDto(</span>
<span class="nc" id="L23">  id: Int,</span>
<span class="nc" id="L24">  name: String,</span>
<span class="nc" id="L25">  email: Option[String] = None,</span>
<span class="nc" id="L26">  confirmed: Boolean = false,</span>
<span class="nc" id="L27">  avatar: Option[String] = None,</span>
<span class="nc" id="L28">  profile: Map[String, String] = Map.empty[String, String],</span>
<span class="nc" id="L29">  mobile: Option[String] = None,</span>
<span class="nc" id="L30">  mobileConfirmed: Boolean = false,</span>
<span class="nc" id="L31">  isAuthenticatorEnabled: Boolean = false,</span>
<span class="nc" id="L32">  lastGIOVersion: Option[String] = None) {</span>
<span class="nc" id="L33">  def toUser: User = User(id = Some(id), confirmed = confirmed, mobileConfirmed = mobileConfirmed)</span>
}

<span class="nc" id="L36">object AccountDto {</span>

<span class="nc bnc" id="L38" title="All 2 branches missed.">  implicit val accountDtoFormatter = Json.format[AccountDto]</span>

<span class="nc" id="L40">  val Empty = AccountDto(-1, &quot;None&quot;)</span>
}

<span class="nc bnc" id="L43" title="All 18 branches missed.">final case class AccountDtos(data: Seq[AccountDto])</span>

<span class="nc" id="L45">object AccountDtos {</span>

<span class="nc bnc" id="L47" title="All 2 branches missed.">  implicit val accountDtosFormatter = Json.format[AccountDtos]</span>
}

<span class="nc bnc" id="L50" title="All 4 branches missed.">object WrappedRequests extends LazyLogging {</span>

  private[this] def getLocale(lng: Option[String]): Locale = {
<span class="nc" id="L53">    lng match {</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">      case None ⇒ Locale.CHINA</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">      case Some(lang) ⇒</span>
<span class="nc" id="L56">        val ranges = Locale.LanguageRange.parse(lang)</span>
<span class="nc" id="L57">        Locale.lookup(ranges, Seq(Locale.CHINA, Locale.CHINESE, Locale.US, Locale.ENGLISH).asJava) match {</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">          case null ⇒ Locale.CHINA</span>
<span class="nc bnc" id="L59" title="All 6 branches missed.">          case Locale.ENGLISH ⇒ Locale.US</span>
<span class="nc bnc" id="L60" title="All 6 branches missed.">          case Locale.CHINESE ⇒ Locale.CHINA</span>
<span class="nc" id="L61">          case _locale ⇒ _locale</span>
        }
    }
  }

<span class="nc" id="L66">  abstract class RequestEndpoint[A](request: Request[A]) extends WrappedRequest[A](request) {</span>
<span class="nc" id="L67">    override def connection: RemoteConnection = request.connection</span>
<span class="nc" id="L68">    override def attrs = request.attrs</span>
<span class="nc" id="L69">    override def target = request.target</span>
  }

<span class="nc" id="L72">  class BehindProxyRequest[A](request: Request[A]) extends RequestEndpoint(request) {</span>

    def realIP = {
<span class="nc" id="L75">      val ipFromFrontend = request.headers.get(&quot;X-Client-IP&quot;)</span>
<span class="nc" id="L76">      val ipFromGateway = request.headers.get(&quot;X-Real-IP&quot;)</span>
<span class="nc" id="L77">      val ips = (ipFromFrontend orElse ipFromGateway).getOrElse(request.remoteAddress).split(&quot;,&quot;).map(_.trim)</span>
<span class="nc" id="L78">      ips.find(x ⇒ IPAddressUtil.isValidIP(x)).getOrElse(ips.head)</span>
    }

    def forwardedIps = {
<span class="nc bnc" id="L82" title="All 2 branches missed.">      logger.info(s&quot;X-Real-Ip: ${request.headers.get(&quot;X-Real-IP&quot;)}&quot;)</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">      logger.info(s&quot;X-Forwarded-For: ${request.headers.get(&quot;X-Forwarded-For&quot;)}&quot;)</span>
<span class="nc" id="L84">      request.headers.get(&quot;X-Forwarded-For&quot;).fold(request.headers.get(&quot;X-Real-IP&quot;).getOrElse(&quot;&quot;))(x ⇒ x)</span>
<span class="nc bnc" id="L85" title="All 6 branches missed.">        .split(',').map(_.trim).filterNot(ip ⇒ ip.equals(&quot;0:0:0:0:0:0:0:1&quot;) || ip.equals(&quot;127.0.0.1&quot;) || ip.startsWith(&quot;10.0.&quot;))</span>
    }

    def validateIp(ips: List[String]): Boolean = {
<span class="nc bnc" id="L89" title="All 2 branches missed.">      if (ips.isEmpty) {</span>
<span class="nc" id="L90">        true</span>
      } else {
<span class="nc" id="L92">        forwardedIps.exists(ip ⇒ ips.contains(ip))</span>
      }
    }
  }

<span class="nc" id="L97">  class UserRequest[A](val account: AccountDto, val user: User, request: Request[A]) extends BehindProxyRequest[A](request) {</span>

<span class="nc bnc" id="L99" title="All 4 branches missed.">    lazy val locale: Locale = {</span>
<span class="nc" id="L100">      getLocale(account.profile.get(&quot;language&quot;) orElse request.acceptLanguages.headOption.map(_.language))</span>
    }

  }

<span class="nc" id="L105">  class ClientRequest[A](val clientId: String, val clientSecrect: String, request: Request[A]) extends BehindProxyRequest[A](request)</span>

<span class="nc" id="L107">  class OrganizationRequest[A](val organization: Organization, request: UserRequest[A]) extends UserRequest[A](request.account, request.user, request) {</span>
<span class="nc" id="L108">    def userId = account.id</span>

<span class="nc" id="L110">    def organizationId = organization.id.get</span>

  }

<span class="nc" id="L114">  class ClientAuthRequest[A](val userIdOpt: Option[Int], val resourceId: Int, request: Request[A]) extends RequestEndpoint(request)</span>

<span class="nc" id="L116">  class ProjectRequest[A](val project: Project, request: UserRequest[A]) extends UserRequest[A](request.account, request.user, request) {</span>
<span class="nc" id="L117">    def userId = account.id</span>

<span class="nc" id="L119">    def projectId = project.dbid</span>

<span class="nc" id="L121">    def ai = project.keyid // 添加 ai 信息</span>

<span class="nc" id="L123">    def projectKeyId = project.keyid</span>

<span class="nc" id="L125">    def organizationId = project.organizationId</span>

<span class="nc" id="L127">    def hostWithProtocol = s&quot;//${request.host}&quot;</span>

    def lastModified = {
      try {
<span class="nc" id="L131">        val zoneTime = request.headers.get(&quot;If-Modified-Since&quot;).map(t ⇒ ZonedDateTime.parse(t, DateTimeFormatter.RFC_1123_DATE_TIME))</span>
<span class="nc" id="L132">        zoneTime.map(z ⇒ new DateTime(</span>
<span class="nc" id="L133">          z.toInstant.toEpochMilli,</span>
<span class="nc" id="L134">          DateTimeZone.forTimeZone(TimeZone.getTimeZone(z.getZone))))</span>
      } catch {
        case e: Exception ⇒
<span class="nc bnc" id="L137" title="All 2 branches missed.">          logger.warn(e + &quot;catch If-Modified-Since header format error ! -&gt; &quot; + request.headers.get(&quot;If-Modified-Since&quot;))</span>
<span class="nc" id="L138">          None</span>
      }
    }
  }

<span class="nc" id="L143">  class AuthenticationRequest[A](val authentication: Authentication, val project: Project, request: Request[A]) extends BehindProxyRequest[A](request) {</span>
<span class="nc" id="L144">    def projectId = project.dbid</span>

<span class="nc bnc" id="L146" title="All 4 branches missed.">    lazy val locale: Locale = {</span>
<span class="nc" id="L147">      getLocale(request.acceptLanguages.headOption.map(_.language))</span>
    }
  }

<span class="nc" id="L151">  class PerformanceRecordRequest[A](request: Request[A]) extends BehindProxyRequest[A](request)</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
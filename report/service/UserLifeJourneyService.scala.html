<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserLifeJourneyService.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">service</a> &gt; <span class="el_source">UserLifeJourneyService.scala</span></div><h1>UserLifeJourneyService.scala</h1><pre class="source lang-java linenums">package service

import com.typesafe.scalalogging.LazyLogging
import dao.{ TagComputeDao, TagDao, UserLifeJourneyDao, UserLifeJourneyStageDao }
import dtos.{ ComputeRequest, UserLifeJourneyComputeDTO, UserLifeJourneyDTO, UserLifeJourneyStageDTO }
import form.{ TagForm, UserLifeJourneyForm, UserLifeJourneyStageForm }
import io.growing.micros.business.model.{ Project, Status }
import io.growing.micros.play.exception.{ BadRequestException, NotFoundException }
import io.growing.micros.play.mvc.FutureUtils
import io.growing.micros.utils.conversion.GrowingConversions.UidWrapper
import io.growing.micros.utils.time.DateTimeUtil.UTCNow
import javax.inject.{ Inject, Singleton }
import model.insight.Tag
import model.{ UserLifeJourney, UserLifeJourneyStage }
import play.api.http.{ Status =&gt; HttpStatus }
import play.api.libs.json.Json
import play.api.libs.ws.WSClient
import service.insight.TagService
import utils.ConfigParams

import scala.collection.immutable.ListMap
import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.Future

@Singleton
<span class="nc bnc" id="L26" title="All 4 branches missed.">class UserLifeJourneyService @Inject() (</span>
<span class="nc" id="L27">  ws: WSClient,</span>
<span class="nc" id="L28">  configParams: ConfigParams,</span>
<span class="nc" id="L29">  tagService: TagService,</span>
<span class="nc" id="L30">  tagDao: TagDao,</span>
<span class="nc" id="L31">  tagComputeDao: TagComputeDao,</span>
<span class="nc" id="L32">  userLifeJourneyDao: UserLifeJourneyDao,</span>
<span class="nc" id="L33">  userLifeJourneyStageDao: UserLifeJourneyStageDao) extends FutureUtils with LazyLogging {</span>

  def findById(projectId: Int): Future[UserLifeJourneyDTO] = {
    for {
<span class="nc" id="L37">      userLifeJourneys &lt;- userLifeJourneyDao.findByProjectId(projectId)</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">      _ &lt;- failCondition(userLifeJourneys.isEmpty, NotFoundException(&quot;未创建用户生命旅程&quot;))</span>
<span class="nc" id="L39">      userLifeJourney = userLifeJourneys.head //目前一个项目只支持一个用户生命旅程</span>
<span class="nc" id="L40">      userLifeJourneyStages &lt;- userLifeJourneyStageDao.findByJourneyId(userLifeJourney.dbid)</span>
<span class="nc" id="L41">      stages &lt;- Future.traverse(userLifeJourneyStages) { stage =&gt;</span>
<span class="nc" id="L42">        stage.tagId.fold(Future.successful(UserLifeJourneyStageDTO(stage, None))) { tagId =&gt;</span>
<span class="nc" id="L43">          Future.successful(stage).zipWith(tagDao.findById(projectId, tagId))(UserLifeJourneyStageDTO.apply)</span>
        }
      }
    } yield {
<span class="nc" id="L47">      UserLifeJourneyDTO(userLifeJourney, stages.sortBy(_.userLifeJourneyStage.rank))</span>
    }
  }

  def queryTagUserNum(form: TagForm, userType: String, projectId: Int): Future[Int] = {
<span class="nc" id="L52">    val tag = Tag.buildByTagForm(projectId, form, -1)</span>
    for {
<span class="nc bnc" id="L54" title="All 2 branches missed.">      compute &lt;- tagService.generateComputes(tag, userType, -1).map(_.head._1)</span>
<span class="nc" id="L55">      computeRequest = ComputeRequest(compute.ai, compute.definition.expression, userType, compute.definition.directives)</span>
<span class="nc" id="L56">      num &lt;- requestInsight(computeRequest)</span>
<span class="nc" id="L57">    } yield num</span>
  }

  def queryStages(projectId: Int): Future[UserLifeJourneyComputeDTO] = {
    for {
<span class="nc" id="L62">      userLifeJourneys &lt;- userLifeJourneyDao.findByProjectId(projectId)</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">      _ &lt;- failCondition(userLifeJourneys.isEmpty, NotFoundException(&quot;未创建用户生命旅程&quot;))</span>
<span class="nc" id="L64">      userLifeJourney = userLifeJourneys.head //目前一个项目只支持一个用户生命旅程</span>
<span class="nc" id="L65">      userLifeJourneyStages &lt;- userLifeJourneyStageDao.findByJourneyId(userLifeJourney.dbid)</span>
<span class="nc bnc" id="L66" title="All 8 branches missed.">      tagComputes &lt;- Future.sequence(userLifeJourneyStages.filter(stage =&gt; stage.state == Status.activated &amp;&amp; stage.tagId.nonEmpty)</span>
<span class="nc" id="L67">        .map(stage =&gt; tagComputeDao.findByTagId(projectId, stage.tagId.get)))</span>
    } yield {
<span class="nc" id="L69">      val computes = ListMap(tagComputes.flatten.map(tagCompute =&gt;</span>
<span class="nc" id="L70">        tagCompute.computeId.toString -&gt;</span>
<span class="nc" id="L71">          userLifeJourneyStages.find(_.tagId.contains(tagCompute.tagId)).map(_.rank).get).sortBy(_._2): _*)</span>
<span class="nc" id="L72">      UserLifeJourneyComputeDTO(userLifeJourney.userType, computes)</span>
    }
  }

  def create(form: UserLifeJourneyForm, project: Project, userId: Int): Future[UserLifeJourneyDTO] = {
<span class="nc" id="L77">    val userLifeJourney = UserLifeJourney(None, project.id.get, project.keyid, form.name, form.userLifeJourneyStage.size, form.userType, userId, userId)</span>
    for {
<span class="nc" id="L79">      _ &lt;- userLifeJourneyDao.findByProjectId(project.id.get).flatMap(results =&gt;</span>
<span class="nc" id="L80">        failCondition(results.nonEmpty, BadRequestException(&quot;不允许重复创建&quot;)))</span>
<span class="nc" id="L81">      dbUserLifeJourney &lt;- userLifeJourneyDao.insert(userLifeJourney)</span>
<span class="nc" id="L82">      stageDto &lt;- Future.traverse(form.userLifeJourneyStage) { stageForm =&gt;</span>
<span class="nc" id="L83">        val stage = UserLifeJourneyStage.buildByForm(project.id.get, dbUserLifeJourney.id.get, stageForm, None, userId)</span>
<span class="nc" id="L84">        stageForm.tag.fold {</span>
<span class="nc" id="L85">          userLifeJourneyStageDao.insert(stage).zipWith(Future.successful(None))((stage, tag) =&gt; UserLifeJourneyStageDTO(stage, tag))</span>
<span class="nc" id="L86">        } { tagForm =&gt;</span>
<span class="nc" id="L87">          val tag = Tag.buildByTagForm(project.id.get, tagForm, userId, stage.state)</span>
<span class="nc" id="L88">          val futureTag = tagService.create(project.id.get, tag, form.userType, userId)</span>
<span class="nc" id="L89">          futureTag.map(t =&gt; stage.copy(tagId = t.id)).flatMap(userLifeJourneyStageDao.insert).zipWith(futureTag)((stage, tag) =&gt; UserLifeJourneyStageDTO(stage, Some(tag)))</span>
        }
      }
    } yield {
<span class="nc" id="L93">      UserLifeJourneyDTO(dbUserLifeJourney, stageDto.sortBy(_.userLifeJourneyStage.rank))</span>
    }
  }

  def update(form: UserLifeJourneyForm, projectId: Int, journeyId: Int, userId: Int): Future[UserLifeJourneyDTO] = {
    for {
<span class="nc bnc" id="L99" title="All 2 branches missed.">      dbUserLifeJourney &lt;- userLifeJourneyDao.findByIdAndProject(journeyId, projectId)</span>
<span class="nc bnc" id="L100" title="All 6 branches missed.">      userTypeChanged = form.userType != dbUserLifeJourney.get.userType</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">      _ &lt;- failCondition(dbUserLifeJourney.isEmpty, NotFoundException(&quot;未创建用户生命旅程&quot;))</span>
<span class="nc" id="L102">      newUserLifeJourney = dbUserLifeJourney.get.copy(name = form.name, userType = form.userType, updaterId = userId, updatedAt = UTCNow)</span>
<span class="nc" id="L103">      _ &lt;- userLifeJourneyDao.update(newUserLifeJourney)</span>
<span class="nc" id="L104">      result &lt;- Future.sequence(form.userLifeJourneyStage.map(stageForm =&gt; updateStage(stageForm, userTypeChanged, projectId, form.userType, userId)))</span>
    } yield {
<span class="nc" id="L106">      UserLifeJourneyDTO(newUserLifeJourney, result.map(tuple =&gt; UserLifeJourneyStageDTO(tuple._1, tuple._2)).sortBy(_.userLifeJourneyStage.rank))</span>
    }
  }

  def updateStage(form: UserLifeJourneyStageForm, userTypeChanged: Boolean, projectId: Int, userType: String, userId: Int): Future[(UserLifeJourneyStage, Option[Tag])] = {
<span class="nc" id="L111">    val noneTag: Option[Tag] = None</span>
    for {
<span class="nc bnc" id="L113" title="All 2 branches missed.">      dbStage &lt;- userLifeJourneyStageDao.findById(form.stageUid.get.toId)</span>
<span class="nc" id="L114">      newStage = dbStage.copy(description = form.description, name = form.name, updaterId = userId, updatedAt = UTCNow, state = form.state)</span>
<span class="nc bnc" id="L115" title="All 4 branches missed.">      (resultStage, maybeTag) &lt;- form.tag.fold(userLifeJourneyStageDao.update(newStage).map(_ =&gt; (newStage, noneTag))) {</span>
<span class="nc" id="L116">        tagForm =&gt;</span>
<span class="nc" id="L117">          val tag = Tag.buildByTagForm(projectId, tagForm, userId, form.state)</span>
<span class="nc" id="L118">          updateTag(tag, dbStage, userTypeChanged, projectId, userType, userId)</span>
<span class="nc" id="L119">            .flatMap(tag =&gt; userLifeJourneyStageDao.update(newStage.copy(tagId = tag.id)).map(_ =&gt; (newStage.copy(tagId = tag.id), Some(tag))))</span>
      }
    } yield {
<span class="nc" id="L122">      (resultStage, maybeTag)</span>
    }
  }

  def updateTag(tag: Tag, dbStage: UserLifeJourneyStage, userTypeChanged: Boolean, projectId: Int, userType: String, userId: Int): Future[Tag] = {
<span class="nc" id="L127">    dbStage.tagId.fold(tagService.create(projectId, tag, userType, userId))(tagId =&gt; tagService.update(projectId, tagId, tag, userTypeChanged, userType, userId))</span>
  }

  private[this] def requestInsight(request: ComputeRequest): Future[Int] = {
<span class="nc bnc" id="L131" title="All 2 branches missed.">    logger.info(s&quot;compute request: ${Json.toJson(request)}&quot;)</span>
<span class="nc" id="L132">    ws.url(configParams.qsHost + configParams.qsPort + configParams.computeNumPath)</span>
<span class="nc" id="L133">      .post(Json.toJson(request))</span>
<span class="nc" id="L134">      .map { response =&gt;</span>
<span class="nc" id="L135">        response.status match {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">          case HttpStatus.OK =&gt; (response.json \ &quot;data&quot;).as[String].toInt</span>
          case _ =&gt;
            val errorMessage =
<span class="nc" id="L139">              s&quot;&quot;&quot;</span>
<span class="nc" id="L140">                 path: ${configParams.qsHost + configParams.qsPort + configParams.computeNumPath}</span>
<span class="nc" id="L141">                 request: ${Json.toJson(request)}</span>
<span class="nc" id="L142">                 response: ${response.toString}</span>
              &quot;&quot;&quot;
<span class="nc" id="L144">            throw new Exception(errorMessage)</span>
        }
      }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JobContext.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">dtos</a> &gt; <span class="el_source">JobContext.scala</span></div><h1>JobContext.scala</h1><pre class="source lang-java linenums">package dtos

import akka.actor.ActorRef
import io.growing.marketing.common.model._

import scala.util.Random

/**
 * JobContext
 * 任务上下文
 * 用于记录 Job、Message、Seq[TaskDto] 之间的关系
 * 每个 product 对应一条 rule 对应生成一个 JobContext 对应一批同渠道的推送任务
 * Message -&gt; Seq[JobContext](每个产品产生一个) -&gt; `Seq[Seq[PushTaskDto]]`(分批推送 需要分段)
 * @author damon lin
 *         2019/5/13
 */
<span class="nc bnc" id="L17" title="All 55 branches missed.">case class JobContext(</span>
<span class="nc" id="L18">  job: PushJob,</span>
<span class="nc" id="L19">  message: PushMessage,</span>
<span class="nc" id="L20">  segmentDto: SegmentDto,</span>
<span class="nc" id="L21">  rule: PushRule,</span>
<span class="nc" id="L22">  tasks: Seq[PushTaskDto] = Seq.empty, // initialed 状态的 job tasks 字段为空</span>
<span class="nc" id="L23">  maybeSender: Option[ActorRef] = None) {</span>

  def textFormat: String = {
<span class="nc" id="L26">    s&quot;message:${message.dbid}; segment:${segmentDto.segmentId}; tasks:${tasks.map(t =&gt; t.task.taskId + &quot;:&quot; + t.channel.channelName).mkString(&quot;-&quot;)}&quot;</span>
  }

  // 使用 uid 方便排查问题
<span class="nc" id="L30">  def id: String = message.uid</span>

}

<span class="nc" id="L34">object JobContext {</span>

  def buildPreviewJob(message: PushMessage, tasks: Seq[PushTaskDto], rule: PushRule) = {
<span class="nc" id="L37">    val fakeId = new Random().nextInt()</span>
<span class="nc" id="L38">    val fakeSegment = Some(&quot;u:-1&quot;) // 预览不用分群</span>
<span class="nc" id="L39">    val previewName = &quot;预览-&quot; + message.name //预览的name加前缀和正式推送的name区分开，防止埋点上报时混在一起</span>
<span class="nc" id="L40">    val previewMessage = message.copy(id = Some(fakeId), name = previewName, audienceId = fakeSegment, audienceType = Some(AudienceType.Segment))</span>
<span class="nc" id="L41">    val job = PushJob.fromMessage(previewMessage)</span>
<span class="nc" id="L42">    JobContext(</span>
<span class="nc" id="L43">      job,</span>
<span class="nc" id="L44">      previewMessage,</span>
<span class="nc" id="L45">      SegmentDto.fromJob(job, 0), // 预览没有使用</span>
<span class="nc" id="L46">      rule,</span>
<span class="nc" id="L47">      tasks)</span>
  }

<span class="nc" id="L50">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
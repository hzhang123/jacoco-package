<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbTestService.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">service</a> &gt; <span class="el_source">AbTestService.scala</span></div><h1>AbTestService.scala</h1><pre class="source lang-java linenums">package service

import dao.{ AbTestDao, AbTestMessageDao, AbTestRuleDao }
import dtos.{ AbTestDto, AbTestMessageDto, EventLevelVarDTO }
import form.{ AbTestForm, AbTestMessageForm }
import handlers.{ AbTestHandler, MessageContentHandler, PushMessageHandler }
import infrastructure.measurement.MessageMeasurementHandler
import io.growing.marketing.common.model._
import io.growing.micros.business.model.{ Project, Status }
import io.growing.micros.play.exception.BadRequestException
import io.growing.micros.play.mvc.FutureUtils
import io.growing.micros.utils.time.DateTimeUtil.UTCNow
import javax.inject.{ Inject, Singleton }

import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.Future

@Singleton
<span class="nc" id="L19">class AbTestService @Inject() (</span>
<span class="nc" id="L20">  abTestDao: AbTestDao,</span>
<span class="nc" id="L21">  abTestMessageDao: AbTestMessageDao,</span>
<span class="nc" id="L22">  abTestRuleDao: AbTestRuleDao,</span>
<span class="nc" id="L23">  pushMetricsHandler: MessageMeasurementHandler,</span>
<span class="nc" id="L24">  pushMessageHandler: PushMessageHandler,</span>
<span class="nc" id="L25">  abTestHandler: AbTestHandler,</span>
<span class="nc" id="L26">  messageContentHandler: MessageContentHandler) extends FutureUtils {</span>

  def create(form: AbTestForm, project: Project, userId: Int): Future[AbTestDto] = {
    for {
<span class="nc" id="L30">      _ &lt;- checkDuplicateName(project.dbid, form.name)</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">      abTestMessages &lt;- Future.sequence(form.messages.map(f =&gt; abTestHandler.createAbTestMessage(f, project, userId, form.name)))</span>
<span class="nc" id="L32">      msgIds = abTestMessages.map(_.id.getOrElse(-1))</span>
<span class="nc" id="L33">      aux = form.messages.zip(abTestMessages)</span>
<span class="nc" id="L34">      abTestMessages &lt;- Future.sequence(aux.map(e =&gt; createProcess(e._1, e._2, project, userId)))</span>
<span class="nc" id="L35">      abTest &lt;- abTestHandler.createAbTest(form, project, userId, msgIds)</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">      dtoList &lt;- convertToDTOs(abTestMessages)</span>
<span class="nc" id="L37">      _ = updateAbTestMessageDimension(abTestMessages, abTest)</span>
<span class="nc" id="L38">    } yield AbTestDto(abTest, dtoList)</span>
  }

  private def createProcess(form: AbTestMessageForm, message: AbTestMessage, project: Project, userId: Int) = {
    for {
<span class="nc" id="L43">      products ← pushMessageHandler.getProductsFromRuleForm(project.dbid, form.rule.get, MessagePlatform.App)</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">      pushMetrics ← abTestHandler.createMetricsIfNecessary(project, userId)</span>
<span class="nc" id="L45">      rulesToCreate = abTestHandler.buildRulesFromForm(form, products, message)</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">      maybeUrl ← form.content match {</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        case Some(content) =&gt;</span>
<span class="nc" id="L48">          val eventVarDTO = EventLevelVarDTO.fromPushMetrics(pushMetrics)</span>
<span class="nc" id="L49">          messageContentHandler.uploadPage(project, content, eventVarDTO, message)</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        case None ⇒ Future.successful(None)</span>
      }
<span class="nc" id="L52">      newMessage = message.copy(contentUrl = maybeUrl, metricsRef = pushMetrics.dbid)</span>
<span class="nc" id="L53">      _ ← processMsgMetricsRules(</span>
<span class="nc" id="L54">        newMessage,</span>
<span class="nc" id="L55">        rulesToCreate)</span>
<span class="nc" id="L56">    } yield newMessage</span>
  }

  private def updateAbTestMessageDimension(abTestMessages: List[AbTestMessage], abTest: AbTest) = {
<span class="nc" id="L60">    abTestMessages.map { m =&gt;</span>
<span class="nc" id="L61">      val newMsg = m.copy(dimension = abTest.abDimension)</span>
<span class="nc" id="L62">      abTestMessageDao.update(newMsg, m.dbid)</span>
    }
  }

  def update(form: AbTestForm, project: Project, abTestId: Int, userId: Int): Future[AbTestDto] = {
    for {
<span class="nc" id="L68">      _ &lt;- checkDuplicateNameInOthers(project.dbid, abTestId, form.name)</span>
<span class="nc" id="L69">      abTestOpt &lt;- abTestDao.findById(project.dbid, abTestId)</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">      _ &lt;- failCondition(abTestOpt.isEmpty, BadRequestException(&quot;未找到该AB测试&quot;))</span>
<span class="nc" id="L71">      oldAbTest = abTestOpt.get</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">      oldAbTestMessages &lt;- abTestMessageDao.findLatestMessages(oldAbTest.latestMessages)</span>
<span class="nc" id="L73">      aux = form.messages.zip(oldAbTestMessages)</span>
<span class="nc" id="L74">      updateNameMsgs = updateNameWhenActivated(form, aux)</span>
<span class="nc" id="L75">      aux2 = form.messages.zip(updateNameMsgs)</span>
<span class="nc" id="L76">      updatedAbTestMessages &lt;- Future.sequence(aux2.map(e =&gt; updateProcess(e._1, e._2, oldAbTest, project, userId)))</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">      newAbTestMessages &lt;- abTestHandler.copyMsgAndRuleIfNecessary(form, oldAbTest, updatedAbTestMessages)</span>
<span class="nc" id="L78">      latestMsgIds = newAbTestMessages.map(_.id.getOrElse(-1)).toList</span>
<span class="nc bnc" id="L79" title="All 12 branches missed.">      historyMsgIds = if (oldAbTest.state == Status.activated &amp;&amp; form.state == Status.stop) latestMsgIds else List()</span>
<span class="nc" id="L80">      newAbTest = abTestHandler.updateAbTest(form, oldAbTest, abTestId, project, userId, historyMsgIds, latestMsgIds)</span>
<span class="nc" id="L81">      dto &lt;- convertToDTOs(newAbTestMessages)</span>
<span class="nc" id="L82">    } yield AbTestDto(newAbTest, dto)</span>
  }

  private def updateNameWhenActivated(form: AbTestForm, pairs: List[(AbTestMessageForm, AbTestMessage)]) = {
<span class="nc bnc" id="L86" title="All 12 branches missed.">    if (form.state == Status.activated || form.state == Status.planning) {</span>
<span class="nc" id="L87">      pairs.map { p =&gt;</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        val n = if (p._1.ctrlGroup) form.name + &quot;-控制组&quot; + p._1.symbol else form.name + &quot;-实验组&quot; + p._1.symbol</span>
<span class="nc" id="L89">        val r = p._2.copy(name = n)</span>
<span class="nc" id="L90">        abTestMessageDao.update(r, p._2.dbid)</span>
<span class="nc" id="L91">        r</span>
      }
    } else {
<span class="nc" id="L94">      pairs.map(_._2)</span>
    }
  }

  private def updateProcess(form: AbTestMessageForm, abTestMessage: AbTestMessage, abTest: AbTest, project: Project, userId: Int) = {
    for {
<span class="nc" id="L100">      products ← pushMessageHandler.getProductsFromRuleForm(project.dbid, form.rule.get, MessagePlatform.App)</span>
<span class="nc bnc" id="L101" title="All 4 branches missed.">      oldRules ← abTestRuleDao.findByMessageId(abTestMessage.dbid)</span>
<span class="nc" id="L102">      newRules = abTestHandler.buildRulesFromForm(form, products, abTestMessage)</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">      (needDeleted, needInserted, needUpdated) = pushMessageHandler.diffRules(abTestMessage, newRules, oldRules)</span>
<span class="nc bnc" id="L104" title="All 8 branches missed.">      firstUpdateToActivated = abTestMessage.state == Status.draft &amp;&amp; form.isActivate</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">      activatedAtValue = if (firstUpdateToActivated) Option(UTCNow) else oldRules.headOption.flatMap(_.activateAt)</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">      contentUrl ← form.content match {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        case Some(content) ⇒ messageContentHandler.updateContent(content, project, abTestMessage, userId)</span>
<span class="nc" id="L108">        case _ ⇒ Future.successful(None)</span>
      }
<span class="nc" id="L110">      resultMsg = abTestHandler.updateAbTestMessage(abTestMessage, form, userId, contentUrl)</span>
<span class="nc" id="L111">      _ ← processMsgMetricsRules(</span>
<span class="nc" id="L112">        resultMsg,</span>
<span class="nc" id="L113">        needInserted.map(_.copy(activateAt = activatedAtValue)),</span>
<span class="nc" id="L114">        needDeleted,</span>
<span class="nc" id="L115">        needUpdated.map(_.copy(activateAt = activatedAtValue, state = resultMsg.state)),</span>
<span class="nc" id="L116">        oldRules = Some(oldRules))</span>
<span class="nc" id="L117">    } yield resultMsg</span>
  }

  /**
   * 查找一条AB测试最新的一对弹窗,用于编辑页,详情页.
   * @param projectId 项目id
   * @param abTestId AB测试id
   * @return
   */
  def findLatestMessages(projectId: Int, abTestId: Int): Future[Either[String, AbTestDto]] = {
<span class="nc" id="L127">    abTestDao.findById(projectId, abTestId).flatMap {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">      case None =&gt; Future.successful(Left(&quot;未找到该AB测试&quot;))</span>
      case abTest =&gt; for {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        dtos &lt;- abTestMessageDao.findLatestMessages(abTest.get.latestMessages).flatMap(convertToDTOs)</span>
<span class="nc" id="L131">        result = AbTestDto(abTest.get, dtos)</span>
<span class="nc" id="L132">      } yield Right(result)</span>
    }
  }

  /**
   * 查找一条AB测试所有历史版本弹窗,用于前端查数据.
   * @param projectId 项目id
   * @param abTestId AB测试id
   * @return
   */
  def findHistoryMessages(projectId: Int, abTestId: Int): Future[Either[String, Seq[AbTestMessageDto]]] = {
<span class="nc" id="L143">    abTestDao.findById(projectId, abTestId).flatMap {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">      case None =&gt; Future.successful(Left(&quot;未找到该AB测试&quot;))</span>
      case abTest =&gt; for {
<span class="nc" id="L146">        result &lt;- abTestMessageDao.findHistoryMessages(abTest.get.messages).flatMap(convertToDTOs)</span>
<span class="nc" id="L147">      } yield Right(result)</span>
    }
  }

  /**
   * 查找项目下所有AB测试最新一对弹窗,用于列表页.
   * @param projectId 项目id
   * @return
   */
  def findAllLatestMessages(projectId: Int): Future[Seq[AbTestDto]] = {
<span class="nc" id="L157">    abTestDao.findByProjectId(projectId).flatMap { a =&gt;</span>
<span class="nc" id="L158">      val r = a.map { abTest =&gt;</span>
<span class="nc" id="L159">        abTestMessageDao.findLatestMessages(abTest.latestMessages)</span>
<span class="nc" id="L160">          .flatMap(convertToDTOs)</span>
<span class="nc" id="L161">          .map(dtos =&gt; AbTestDto(abTest, dtos))</span>
      }
<span class="nc" id="L163">      Future.sequence(r)</span>
    }
  }

  def archive(projectId: Int, abTestId: Int): Future[Option[Int]] = {
<span class="nc" id="L168">    abTestDao.findById(projectId, abTestId).flatMap {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">      case None =&gt; Future.successful(None)</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">      case Some(a) =&gt;</span>
<span class="nc" id="L171">        abTestMessageDao.deleteByIds(a.messages)</span>
<span class="nc" id="L172">        abTestDao.deleteById(projectId, abTestId).map(Some(_))</span>
    }
  }

  private def convertToDTOs(messages: Seq[AbTestMessage]) = {
<span class="nc" id="L177">    Future.traverse(messages) { message =&gt;</span>
<span class="nc" id="L178">      val filter = pushMessageHandler.convertFilterToForm(message.audienceFilter)</span>
      for (
<span class="nc" id="L180">        rules &lt;- abTestRuleDao.findByMessageId(message.dbid);</span>
<span class="nc" id="L181">        metrics &lt;- pushMetricsHandler.findById(message.metricsRef)</span>
<span class="nc" id="L182">      ) yield AbTestMessageDto(message, rules, metrics, filter)</span>
    }
  }

  private def processMsgMetricsRules(
    abTestMessage: AbTestMessage,
    rulesToCreate: Seq[PushRule],
<span class="nc" id="L189">    rulesToDelete: Seq[PushRule] = Seq(),</span>
<span class="nc" id="L190">    rulesToUpdate: Seq[PushRule] = Seq(),</span>
<span class="nc" id="L191">    oldRules: Option[Seq[PushRule]] = None): Future[Unit] = {</span>
<span class="nc" id="L192">    abTestMessageDao.updateMsgMetricsRules(abTestMessage, rulesToCreate, rulesToDelete, rulesToUpdate, oldRules)</span>
  }

  private def checkDuplicateName(projectId: Int, name: String) = {
<span class="nc" id="L196">    abTestDao.findByName(projectId, name).flatMap { o =&gt;</span>
<span class="nc" id="L197">      failCondition(o.isDefined, BadRequestException(s&quot;${name}已存在,请更换名字&quot;))</span>
    }
  }

  private def checkDuplicateNameInOthers(projectId: Int, id: Int, name: String) = {
<span class="nc" id="L202">    abTestDao.findByNameInOthers(projectId, id, name).flatMap { o =&gt;</span>
<span class="nc" id="L203">      failCondition(o.isDefined, BadRequestException(s&quot;${name}已存在,请更换名字&quot;))</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DimensionRpcClient.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">infrastructure.measurement.dimension</a> &gt; <span class="el_source">DimensionRpcClient.scala</span></div><h1>DimensionRpcClient.scala</h1><pre class="source lang-java linenums">package infrastructure.measurement.dimension

import com.google.common.base.Charsets
import com.google.inject.{ Inject, Singleton }
import com.google.protobuf.Any
import form.{ EventLevelVarForm, RealTimeDimensionForm, VisitorVariableForm }
import io.growing.events.grpc.v1.InsightServiceGrpc.InsightServiceStub
import io.growing.events.grpc.v1.VariableServiceGrpc.VariableServiceStub
import io.growing.events.grpc.v1.{ BatchCreateVariableRequest, GetDimensionsRequest }
import io.growing.events.protobuf.Variables.VariableType
import io.growing.events.protobuf._
import io.growing.micros.middleware.rpc.grpc.GrpcClient
import io.growing.micros.utils.SignUtilities
import io.growing.micros.utils.hash.HashIdGenerator
import io.grpc.CallOptions
import org.joda.time.DateTime
import org.slf4j.LoggerFactory
import play.api.http.Status
import play.api.libs.json.Json
import play.api.libs.ws.{ WSAuthScheme, WSClient }
import utils.ConfigParams

import scala.collection.JavaConverters._
import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.Future

@Singleton
<span class="fc" id="L28">class DimensionRpcClient @Inject() (ws: WSClient, configParams: ConfigParams, grpcClient: GrpcClient) {</span>

<span class="nc bnc" id="L30" title="All 4 branches missed.">  private lazy val logger = LoggerFactory.getLogger(getClass)</span>
<span class="pc" id="L31">  private val REMOTE_EVENT_SERVICE_NAME = &quot;events-service&quot;</span>
  // 为了数据管理中看不到，所以设置userId为-1
<span class="pc" id="L33">  private val DEFAULT_USER_ID = -1</span>

  def createEventLevelVars(projectId: Int, userId: Int, eventLevelVarForms: Seq[EventLevelVarForm]): Future[Seq[EventVariableDto]] = {
<span class="nc" id="L36">    logger.info(&quot;CreateEventLevelVar form: &quot; + Json.toJson(eventLevelVarForms))</span>

<span class="nc" id="L38">    val events = eventLevelVarForms.map { ef =&gt;</span>
<span class="nc" id="L39">      EventVariableDto.newBuilder()</span>
<span class="nc" id="L40">        .setKey(ef.key)</span>
<span class="nc" id="L41">        .setName(ef.name)</span>
<span class="nc" id="L42">        .setDescription(ef.description.get)</span>
<span class="nc" id="L43">        .setValueType(ef.valueType)</span>
<span class="nc" id="L44">        .setIsSystem(ef.isSystem)</span>
<span class="nc" id="L45">        .setCreator(DEFAULT_USER_ID.toString)</span>
    }

<span class="nc" id="L48">    val requestBuilder = BatchCreateVariableRequest.newBuilder()</span>
<span class="nc" id="L49">      .setProjectId(projectId)</span>
<span class="nc" id="L50">      .setIsSystem(true)</span>
<span class="nc" id="L51">      .setCreatorId(DEFAULT_USER_ID)</span>
<span class="nc" id="L52">      .setTypeValue(VariableType.EVENT.getNumber)</span>

<span class="nc" id="L54">    events.foreach(e =&gt; requestBuilder.addVariables(Any.pack(e.build())))</span>

<span class="nc" id="L56">    grpcClient</span>
<span class="nc" id="L57">      .target[VariableServiceStub, BatchCreateVariableRequest, Any](REMOTE_EVENT_SERVICE_NAME)</span>
<span class="nc" id="L58">      .withOptions(CallOptions.DEFAULT)</span>
<span class="nc" id="L59">      .withRequest(requestBuilder.build())</span>
<span class="nc" id="L60">      .stream(stub ⇒ stub.batchCreate)</span>
<span class="nc" id="L61">      .map { result =&gt;</span>
<span class="nc" id="L62">        logger.info(&quot;createEventLevelVar result&quot; + result)</span>
<span class="nc" id="L63">        result.map(_.unpack(classOf[EventVariableDto]))</span>
      }
  }

  def createVisitorVariables(projectId: Int, visitorVariableForms: Seq[VisitorVariableForm]): Future[Seq[VisitorVariableDto]] = {
<span class="nc" id="L68">    logger.info(&quot;createVisitorVariables form: &quot; + Json.toJson(visitorVariableForms))</span>

<span class="nc" id="L70">    val vars = visitorVariableForms.map { form =&gt;</span>
<span class="nc" id="L71">      VisitorVariableDto.newBuilder()</span>
<span class="nc" id="L72">        .setKey(form.key)</span>
<span class="nc" id="L73">        .setName(form.name)</span>
<span class="nc" id="L74">        .setDescription(form.description.getOrElse(&quot;&quot;))</span>
<span class="nc" id="L75">        .setIsSystem(form.isSystem)</span>
<span class="nc" id="L76">        .setCreator(DEFAULT_USER_ID.toString)</span>
    }

<span class="nc" id="L79">    val requestBuilder = BatchCreateVariableRequest.newBuilder()</span>
<span class="nc" id="L80">      .setProjectId(projectId)</span>
<span class="nc" id="L81">      .setIsSystem(true)</span>
<span class="nc" id="L82">      .setCreatorId(DEFAULT_USER_ID)</span>
<span class="nc" id="L83">      .setTypeValue(VariableType.VISITOR.getNumber)</span>

<span class="nc" id="L85">    vars.foreach(e =&gt; requestBuilder.addVariables(Any.pack(e.build())))</span>

<span class="nc" id="L87">    grpcClient</span>
<span class="nc" id="L88">      .target[VariableServiceStub, BatchCreateVariableRequest, Any](REMOTE_EVENT_SERVICE_NAME)</span>
<span class="nc" id="L89">      .withOptions(CallOptions.DEFAULT)</span>
<span class="nc" id="L90">      .withRequest(requestBuilder.build())</span>
<span class="nc" id="L91">      .stream(stub ⇒ stub.batchCreate)</span>
<span class="nc" id="L92">      .map { result =&gt;</span>
<span class="nc" id="L93">        logger.info(&quot;createVisitorVariables result&quot; + result)</span>
<span class="nc" id="L94">        result.map(_.unpack(classOf[VisitorVariableDto]))</span>
      }
  }

  def modifyRealTimeDimension(
    projectId: Int,
    userId: Int,
    eventIds: Seq[String],
    varKey: String,
    varValue: String,
    deltaCount: Int): Future[Boolean] = {
<span class="nc" id="L105">    val signWrapper = generateSignWrapper(projectId, userId)</span>
<span class="nc" id="L106">    val projectHashId = signWrapper.projectHashId</span>
<span class="nc" id="L107">    logger.info(s&quot;Modify real time dimension of $varKey : $varValue .&quot;)</span>
<span class="nc" id="L108">    preRequest(s&quot;/internal/v3/projects/$projectHashId/realtime/dimensions&quot;, signWrapper, userId)</span>
<span class="nc" id="L109">      .post(Json.toJson(RealTimeDimensionForm(varKey, varValue, eventIds, deltaCount)))</span>
<span class="nc" id="L110">      .map { response =&gt;</span>
<span class="nc" id="L111">        val key = s&quot; $projectId - $varKey - $varValue - $deltaCount &quot;</span>
<span class="nc" id="L112">        response.status match {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">          case Status.OK =&gt;</span>
<span class="nc" id="L114">            logger.info(s&quot;Request createRealTimeDimension for $key ok&quot;)</span>
<span class="nc" id="L115">            true</span>
          case _ =&gt;
<span class="nc" id="L117">            logger.error(s&quot;Request createRealTimeDimension for $key failure, reason is: ${response.status} ${response.body} !&quot;)</span>
<span class="nc" id="L118">            false</span>
        }
      }
  }

  def getDimensions(projectId: Int, keys: Seq[String]): Future[Seq[DimensionDto]] = {
<span class="nc" id="L124">    val request = GetDimensionsRequest.newBuilder().setProjectId(projectId).addAllDimensions(keys.asJava).build()</span>
<span class="nc" id="L125">    grpcClient</span>
<span class="nc" id="L126">      .target[InsightServiceStub, GetDimensionsRequest, DimensionDto](REMOTE_EVENT_SERVICE_NAME)</span>
<span class="nc" id="L127">      .withOptions(CallOptions.DEFAULT)</span>
<span class="nc" id="L128">      .withRequest(request)</span>
<span class="nc" id="L129">      .stream(stub =&gt; stub.getDimensions)</span>
<span class="nc" id="L130">      .map { dimensions =&gt;</span>
<span class="nc" id="L131">        logger.info(s&quot;getDimensions result: $dimensions&quot;)</span>
<span class="nc" id="L132">        dimensions</span>
      }
  }

<span class="nc" id="L136">  private[this] def preRequest(path: String, signWrapper: SignWrapper, userId: Int, isAddHost: Boolean = true) = {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">    val actualUrl = if (isAddHost) configParams.host + configParams.port + path else path</span>
<span class="nc" id="L138">    val sign = signWrapper.sign</span>
<span class="nc" id="L139">    logger.info(&quot;PreRequest remote url: &quot; + actualUrl)</span>
<span class="nc" id="L140">    val rb = ws.url(actualUrl)</span>
<span class="nc" id="L141">      .withHttpHeaders(</span>
<span class="nc" id="L142">        &quot;X-Inner-User-Id&quot; -&gt; userId.toString,</span>
<span class="nc" id="L143">        &quot;Content-Type&quot; -&gt; &quot;application/json;charset=utf-8&quot;,</span>
<span class="nc" id="L144">        &quot;X-Timestamp&quot; -&gt; signWrapper.timestamp.toString,</span>
<span class="nc" id="L145">        &quot;Accept&quot; -&gt; &quot;application/json; charset=utf-8&quot;)</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">    if (isAddHost) {</span>
<span class="nc" id="L147">      rb.addHttpHeaders(&quot;Authorization&quot; -&gt; s&quot;Sign $sign&quot;)</span>
    } else {
<span class="nc" id="L149">      rb.withAuth(configParams.token, configParams.token, WSAuthScheme.BASIC)</span>
    }
  }

  private def generateSignWrapper(projectId: Int, userId: Int): SignWrapper = {
<span class="nc" id="L154">    val projectHashId = HashIdGenerator.hashId(projectId)</span>
    // calculate sign
<span class="nc" id="L156">    val timestamp = DateTime.now().getMillis</span>
<span class="nc" id="L157">    val sign = SignUtilities.md5(Seq(configParams.token, projectId, userId, timestamp), Charsets.UTF_8)</span>
<span class="nc" id="L158">    SignWrapper(projectHashId, timestamp, sign)</span>
  }

<span class="fc" id="L161">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
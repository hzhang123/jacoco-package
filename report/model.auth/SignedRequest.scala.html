<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SignedRequest.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">model.auth</a> &gt; <span class="el_source">SignedRequest.scala</span></div><h1>SignedRequest.scala</h1><pre class="source lang-java linenums">package model.auth

import javax.crypto.Mac
import javax.crypto.spec.SecretKeySpec
import org.apache.commons.codec.binary.Hex

/**
 * SignedRequest
 *
 * @author damon lin
 *         2019/7/16
 */
<span class="nc bnc" id="L13" title="All 34 branches missed.">case class SignedRequest(method: String, path: String, query: Map[String, String]) {</span>
<span class="nc" id="L14">  var signed = false</span>
<span class="nc" id="L15">  var signedString = &quot;&quot;</span>

  def validate(token: Token): Boolean = {
<span class="nc bnc" id="L18" title="All 2 branches missed.">    if (!signed) {</span>
<span class="nc" id="L19">      return false</span>
    }
<span class="nc" id="L21">    query.getOrElse(&quot;auth&quot;, &quot;&quot;).equals(signedString)</span>
  }

  def sign(token: Token): Map[String, String] = {
<span class="nc" id="L25">    Map[String, String](</span>
<span class="nc" id="L26">      &quot;auth_version&quot; -&gt; &quot;1.0&quot;,</span>
<span class="nc" id="L27">      &quot;auth_key&quot; -&gt; token.key,</span>
<span class="nc" id="L28">      &quot;auth_timestamp&quot; -&gt; System.currentTimeMillis().toString,</span>
<span class="nc" id="L29">      &quot;auth_signature&quot; -&gt; signature(token))</span>
  }

  def signature(token: Token): String = {
<span class="nc" id="L33">    val hmac: Mac = Mac.getInstance(&quot;HmacSHA256&quot;)</span>
<span class="nc" id="L34">    hmac.init(new SecretKeySpec(token.secret.getBytes(&quot;UTF-8&quot;), &quot;HmacSHA256&quot;))</span>
<span class="nc" id="L35">    val signature = hmac.doFinal(stringToSign.getBytes(&quot;UTF-8&quot;))</span>
<span class="nc" id="L36">    signedString = Hex.encodeHexString(signature)</span>
<span class="nc" id="L37">    signed = true</span>
<span class="nc" id="L38">    signedString</span>
  }

  def stringToSign: String = {
<span class="nc" id="L42">    s&quot;$method\n$path\n$parameters&quot;</span>
  }

  def parameters: String = {
<span class="nc bnc" id="L46" title="All 2 branches missed.">    query.foldLeft(List.empty[String]) {</span>
<span class="nc" id="L47">      case (list, qs) =&gt;</span>
<span class="nc" id="L48">        val key = qs._1.toLowerCase</span>
<span class="nc" id="L49">        val value = qs._2</span>
<span class="nc" id="L50">        key match {</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">          case &quot;auth&quot; =&gt; list</span>
          case _ =&gt; {
<span class="nc" id="L53">            val parameter = s&quot;${key}=${value}&quot;</span>
<span class="nc" id="L54">            list ::: parameter :: Nil</span>
          }
        }
<span class="nc" id="L57">    }.mkString(&quot;&amp;&quot;)</span>
  }
}

<span class="nc" id="L61">object SignedRequest {</span>

<span class="nc" id="L63">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbTestMessageDto.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">dtos</a> &gt; <span class="el_source">AbTestMessageDto.scala</span></div><h1>AbTestMessageDto.scala</h1><pre class="source lang-java linenums">package dtos

import form.{ PushFilterForm, PushRuleTarget }
import io.growing.marketing.common.model.{ AbTestMessage, PushMetrics, PushRule }
import io.growing.micros.utils.conversion.GrowingConversions._
import org.joda.time.DateTime
import play.api.libs.json._
import utils.MappingUtil

<span class="nc bnc" id="L10" title="All 41 branches missed.">case class AbTestMessageDto(</span>
<span class="nc" id="L11">  message: AbTestMessage,</span>
<span class="nc" id="L12">  rules: Seq[PushRule],</span>
<span class="nc" id="L13">  metrics: Option[PushMetrics],</span>
<span class="nc" id="L14">  audienceFilterForm: Option[PushFilterForm] = None)</span>

<span class="nc" id="L16">object AbTestMessageDto {</span>
<span class="nc" id="L17">  private val MAPPING = Map(&quot;u&quot; -&gt; &quot;uv&quot;, &quot;cs1&quot; -&gt; &quot;usv&quot;)</span>
<span class="nc" id="L18">  private val ABBREVIATION = &quot;var_&quot;</span>

<span class="nc" id="L20">  implicit object JodaDateTimeNumberWrites extends Writes[DateTime] {</span>
<span class="nc" id="L21">    def writes(d: DateTime): JsValue = JsNumber(d.getMillis)</span>
  }

<span class="nc" id="L24">  implicit val writes: Writes[AbTestMessageDto] = (o: AbTestMessageDto) =&gt; {</span>
    val msg = o.message
    val r = o.rules.headOption
    val m = o.metrics
    val abMetric = msg.abMetric
    val f = o.audienceFilterForm
    var base = Json.obj(
<span class="nc" id="L31">      &quot;id&quot; -&gt; msg.id.getOrElse(-1).toUid,</span>
      &quot;state&quot; -&gt; msg.state,
      &quot;audienceType&quot; -&gt; msg.audienceType,
<span class="nc" id="L34">      &quot;audienceId&quot; -&gt; MappingUtil.segmentIdMapping(msg.audienceId, MAPPING, id =&gt; id.toInt.toUid),</span>
      &quot;creator&quot; -&gt; msg.creatorId.toUid,
      &quot;updater&quot; -&gt; msg.updaterId.toUid,
      &quot;createdAt&quot; -&gt; msg.createdAt,
      &quot;updateAt&quot; -&gt; msg.updatedAt,
      &quot;rate&quot; -&gt; msg.rate,
      &quot;symbol&quot; -&gt; msg.symbol,
      &quot;ctrlGroup&quot; -&gt; msg.ctrlGroup,
      &quot;abVersion&quot; -&gt; msg.abTestVersion,
      &quot;platform&quot; -&gt; msg.platform,
      &quot;name&quot; -&gt; msg.name,
      &quot;totalActivatedTimes&quot; -&gt; msg.totalActivatedTimes)

<span class="nc" id="L47">    val targets = o.rules.flatMap(PushRuleTarget.fromRule)</span>

<span class="nc" id="L49">    r.foreach { rule ⇒</span>
<span class="nc" id="L50">      base ++= Json.obj(&quot;rule&quot; -&gt; Json.obj(</span>
<span class="nc" id="L51">        &quot;type&quot; -&gt; rule.`type`,</span>
<span class="nc" id="L52">        &quot;action&quot; -&gt; rule.action,</span>
<span class="nc" id="L53">        &quot;targets&quot; -&gt; targets,</span>
<span class="nc" id="L54">        &quot;limit&quot; -&gt; rule.limit,</span>
<span class="nc" id="L55">        &quot;activateAt&quot; -&gt; rule.activateAt,</span>
<span class="nc" id="L56">        &quot;productIds&quot; -&gt; o.rules.filter(_.productId.nonEmpty).map(_.productId.get.toUid),</span>
<span class="nc" id="L57">        &quot;triggerPages&quot; → o.rules.flatMap(_.triggerPages),</span>
<span class="nc" id="L58">        &quot;startAt&quot; → rule.startAt,</span>
<span class="nc" id="L59">        &quot;endAt&quot; → rule.endAt,</span>
<span class="nc" id="L60">        &quot;triggerDelay&quot; → rule.triggerDelay,</span>
<span class="nc" id="L61">        &quot;triggerCd&quot; → rule.triggerCd,</span>
<span class="nc" id="L62">        &quot;scheduleAt&quot; -&gt; rule.scheduleAt,</span>
<span class="nc" id="L63">        &quot;actionType&quot; -&gt; rule.actionType,</span>
<span class="nc" id="L64">        &quot;actionTarget&quot; -&gt; rule.actionTarget,</span>
<span class="nc" id="L65">        &quot;actionParameter&quot; -&gt; rule.actionParameters,</span>
<span class="nc" id="L66">        &quot;triggerFilter&quot; -&gt; rule.triggerFilter))</span>
    }

    if (msg.contentMetadata.isDefined) {
      base ++= Json.obj(
        &quot;content&quot; -&gt; Json.toJson(msg.contentMetadata))
    }
    if (m.isDefined) {
      base ++= Json.obj(
<span class="nc" id="L75">        &quot;ctaMetrics&quot; -&gt; m.map(_.ctaClicks.map(_.toUid)),</span>
<span class="nc" id="L76">        &quot;messageImp&quot; -&gt; m.map(_.messageImp.map(_.toUid)),</span>
<span class="nc" id="L77">        &quot;messageClose&quot; -&gt; m.map(_.messageClose.map(_.toUid)),</span>
<span class="nc" id="L78">        &quot;messageSent&quot; -&gt; m.map(_.messageSent.map(_.toUid)))</span>
<span class="nc" id="L79">      if (m.flatMap(_.varKey).isDefined) {</span>
        var filter = Json.obj(
<span class="nc" id="L81">          &quot;name&quot; -&gt; m.map(_.varName),</span>
<span class="nc" id="L82">          &quot;type&quot; -&gt; m.map(_.varType),</span>
<span class="nc" id="L83">          &quot;id&quot; -&gt; m.flatMap(_.varDBId.map(_.toUid)))</span>
<span class="nc" id="L84">        filter += (&quot;key&quot; -&gt; JsString(ABBREVIATION + m.flatMap(_.varKey).get))</span>
        base ++= Json.obj(&quot;filter&quot; -&gt; filter)
      }
    }
    if (f.isDefined) {
      base ++= Json.obj(
        &quot;audienceFilter&quot; -&gt; f.get)
    }
    if (abMetric.isDefined) {
      base ++= Json.obj(&quot;metric&quot; -&gt; Json.obj(
        &quot;id&quot; -&gt; abMetric.get.id.toUid,
        &quot;type&quot; -&gt; abMetric.get.typ))
    }
    base
  }
<span class="nc" id="L99">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MeasurementParser.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">service.insight</a> &gt; <span class="el_source">MeasurementParser.scala</span></div><h1>MeasurementParser.scala</h1><pre class="source lang-java linenums">package service.insight

import com.typesafe.scalalogging.LazyLogging
import infrastructure.measurement.dimension.DimensionRpcClient
import infrastructure.measurement.metrics.MetricRpcClient
import javax.inject.{ Inject, Singleton }
import model.insight.{ ComputeExpression, GlobalAttribute, Measurement }
import org.apache.commons.lang3.NotImplementedException

import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.Future

/**
 * @author : xhldtc
 * @since : 2019/12/4
 */
@Singleton
<span class="nc bnc" id="L18" title="All 4 branches missed.">class MeasurementParser @Inject() (</span>
<span class="nc" id="L19">  dimensionRpcClient: DimensionRpcClient,</span>
<span class="nc" id="L20">  metricRpcClient: MetricRpcClient) extends LazyLogging {</span>

  def parseMeasurement(projectId: Int, measurement: Measurement): Future[ComputeExpression] = {
<span class="nc" id="L23">    measurement.`type` match {</span>
<span class="nc bnc" id="L24" title="All 2 branches missed.">      case &quot;tag&quot; =&gt; throw new NotImplementedException(&quot;tag type is not supported!&quot;)</span>
<span class="nc bnc" id="L25" title="All 2 branches missed.">      case &quot;attribute&quot; =&gt;</span>
<span class="nc" id="L26">        getAttributeExpression(projectId, measurement).map { expression ⇒</span>
<span class="nc" id="L27">          ComputeExpression(&quot;dimension&quot;, expression)</span>
        }
<span class="nc bnc" id="L29" title="All 2 branches missed.">      case _: String =&gt;</span>
<span class="nc" id="L30">        getMetricExpression(projectId, measurement) map { expression ⇒</span>
<span class="nc" id="L31">          ComputeExpression(&quot;event&quot;, expression)</span>
        }
    }
  }

  def parseAttribute(projectId: Int, attribute: String): Future[String] = {
<span class="nc bnc" id="L37" title="All 2 branches missed.">    if (GlobalAttribute.values.map(_.toString).contains(attribute)) {</span>
<span class="nc" id="L38">      Future.successful(attribute)</span>
    } else {
<span class="nc" id="L40">      dimensionRpcClient.getDimensions(projectId, Seq(attribute)).map(_.head.getId)</span>
    }
  }

  private[this] def getMetricExpression(projectId: Int, measurement: Measurement): Future[String] = {
<span class="nc" id="L45">    metricRpcClient.getMetrics(projectId, Seq(measurement)).map(_.head.getExpression)</span>
  }

<span class="nc" id="L48">  private[this] def getAttributeExpression(projectId: Int, measurement: Measurement): Future[String] = {</span>
<span class="nc" id="L49">    dimensionRpcClient.getDimensions(projectId, Seq(measurement.key.get)).map(_.head.getId)</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">      .recover {</span>
<span class="nc bnc" id="L51" title="All 4 branches missed.">        case t: Throwable =&gt;</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">          logger.warn(&quot;query dimensions failed, return same key&quot;, t)</span>
<span class="nc" id="L53">          measurement.key.get</span>
      }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
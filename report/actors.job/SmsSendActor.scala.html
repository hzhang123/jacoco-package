<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SmsSendActor.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">actors.job</a> &gt; <span class="el_source">SmsSendActor.scala</span></div><h1>SmsSendActor.scala</h1><pre class="source lang-java linenums">package actors.job

import actors.Injector
import akka.actor.{ Actor, Props }
import com.google.gson.Gson
import com.typesafe.scalalogging.LazyLogging
import dtos.GroupUsersRequest
import dtos.Messages.{ SmsMessage, SmsSubTask }
import infrastructure.kafka.KafkaCommonClient
import io.growing.marketing.common.model.{ ShortMessage, SmsConfig, SmsProvider }
import io.growing.micros.utils.conversion.GrowingConversions._
import javax.inject.Inject

import scala.collection.JavaConverters._
import scala.concurrent.ExecutionContext.Implicits.global

<span class="pc bnc" id="L17" title="All 4 branches missed.">class SmsSendActor @Inject() (injector: Injector) extends Actor with LazyLogging {</span>
<span class="pc" id="L18">  private val smsQueryUsersClient = injector.smsQueryUsersClient</span>
<span class="pc" id="L19">  private val kafkaClient = KafkaCommonClient[SmsMessage](injector.configParams.smsTopic, injector.config)</span>

<span class="pc bpc" id="L21" title="1 of 2 branches missed.">  override def receive: Receive = {</span>
<span class="nc bnc" id="L22" title="All 4 branches missed.">    case smsSubTask: SmsSubTask =&gt; send(smsSubTask)</span>
  }

  private def send(smsSubTask: SmsSubTask) = {
    for {
<span class="nc" id="L27">      shortMsg &lt;- injector.shortMessageDao.findByShortMessageId(smsSubTask.getShortMsgId)</span>
<span class="nc" id="L28">      smsConfig &lt;- injector.smsConfigDao.findByConfigId(smsSubTask.getSmsConfigId)</span>
<span class="nc" id="L29">      kafkaMsg &lt;- assembleKafkaMsg(smsSubTask, shortMsg.get, smsConfig.get)</span>
    } yield {
<span class="nc bnc" id="L31" title="All 2 branches missed.">      logger.info(s&quot;kafkaMsg: $kafkaMsg&quot;)</span>
<span class="nc" id="L32">      kafkaClient.send(kafkaMsg)</span>
    }
  }

  private def assembleKafkaMsg(s: SmsSubTask, shortMsg: ShortMessage, config: SmsConfig) = {
<span class="nc" id="L37">    smsQueryUsersClient.usersInfo(GroupUsersRequest(s.getAi, s.getTagId, s.getField, s.getStart,</span>
<span class="nc" id="L38">      s.getEnd, s.getAttrs)).map { userInfoList =&gt;</span>
<span class="nc" id="L39">      val phoneNumbers = userInfoList.map(_.info(1))</span>
<span class="nc" id="L40">      val attrValues = userInfoList.map(_.info.drop(2))</span>
<span class="nc" id="L41">      val baseMsg = SmsMessage.newBuilder().setId(s&quot;sms ${shortMsg.dbid.toUid}&quot;)</span>
<span class="nc" id="L42">      val arguments = Arguments(attrValues, phoneNumbers, shortMsg, config, baseMsg)</span>
<span class="nc" id="L43">      config.smsProvider match {</span>
<span class="nc bnc" id="L44" title="All 6 branches missed.">        case SmsProvider.aliyun =&gt;</span>
<span class="nc" id="L45">          buildAliyunMsg(arguments)</span>
<span class="nc bnc" id="L46" title="All 6 branches missed.">        case SmsProvider.yunpian =&gt;</span>
<span class="nc" id="L47">          buildYunpianMsg(arguments)</span>
<span class="nc bnc" id="L48" title="All 6 branches missed.">        case SmsProvider.chuanglan =&gt;</span>
<span class="nc" id="L49">          buildChuanglanMsg(arguments)</span>
      }
    }
  }

  private def buildAliyunMsg(arg: Arguments) = {
<span class="nc" id="L55">    val paramJson = new Gson().toJson(</span>
<span class="nc" id="L56">      arg.attrValues.map { v =&gt;</span>
<span class="nc" id="L57">        arg.shortMsg.templateParams.map(_.replaceAll(&quot;[{}]&quot;, &quot;&quot;)).zip(v).toMap</span>
<span class="nc" id="L58">      }.map(m =&gt; m.asJava).asJava)</span>
<span class="nc" id="L59">    arg.baseMsg.setReceiver(new Gson().toJson(arg.phoneNumbers.asJava))</span>
<span class="nc" id="L60">      .addTemplate(arg.shortMsg.templateCode.getOrElse(&quot;&quot;))</span>
<span class="nc" id="L61">      .setProviderKey(arg.config.providerKey)</span>
<span class="nc" id="L62">      .setProviderValue(arg.config.providerValue.getOrElse(&quot;&quot;))</span>
<span class="nc" id="L63">      .setSignName(new Gson().toJson(arg.phoneNumbers.map(_ =&gt; arg.shortMsg.signName.getOrElse(&quot;&quot;)).asJava))</span>
<span class="nc" id="L64">      .setSmsProvider(SmsMessage.SmsProvider.ALIYUN)</span>
<span class="nc" id="L65">      .setTemplateParam(paramJson)</span>
      .build()
  }

  private def buildYunpianMsg(arg: Arguments) = {
<span class="nc" id="L70">    arg.baseMsg.setReceiver(arg.phoneNumbers.mkString(&quot;,&quot;))</span>
<span class="nc" id="L71">      .setProviderKey(arg.config.providerKey)</span>
<span class="nc" id="L72">      .addAllTemplate(arg.attrValues.map { a =&gt;</span>
<span class="nc" id="L73">        arg.shortMsg.templateContent.getOrElse(&quot;&quot;)</span>
<span class="nc" id="L74">          .replaceAll(&quot;\\#(.*?)\\#&quot;, &quot;%s&quot;).format(a: _*)</span>
      }.asJava)
<span class="nc" id="L76">      .setSmsProvider(SmsMessage.SmsProvider.YUNPIAN)</span>
      .build()
  }

  private def buildChuanglanMsg(arg: Arguments) = {
<span class="nc bnc" id="L81" title="All 2 branches missed.">    val sendPath = if (injector.shortMessageHandler.getTemplateParams(arg.shortMsg.templateContent.getOrElse(&quot;&quot;), arg.config).nonEmpty) {</span>
<span class="nc" id="L82">      s&quot;http://${arg.config.sendPath.getOrElse(&quot;&quot;)}/msg/variable/json&quot;</span>
    } else {
<span class="nc" id="L84">      s&quot;http://${arg.config.sendPath.getOrElse(&quot;&quot;)}/msg/send/json&quot;</span>
    }
<span class="nc bnc" id="L86" title="All 2 branches missed.">    val templateParam = if (arg.attrValues.flatten.isEmpty) {</span>
<span class="nc" id="L87">      arg.phoneNumbers.mkString(&quot;,&quot;)</span>
    } else {
<span class="nc" id="L89">      arg.phoneNumbers.map { p =&gt;</span>
<span class="nc" id="L90">        (p :: arg.attrValues(arg.phoneNumbers.indexOf(p)).toList).mkString(&quot;,&quot;)</span>
<span class="nc" id="L91">      }.mkString(&quot;;&quot;)</span>
    }
<span class="nc" id="L93">    arg.baseMsg.setTemplateParam(templateParam)</span>
<span class="nc" id="L94">      .addTemplate(s&quot;【${arg.shortMsg.signName.getOrElse(&quot;&quot;)}】${arg.shortMsg.templateContent.getOrElse(&quot;&quot;)}&quot;)</span>
<span class="nc" id="L95">      .setSmsProvider(SmsMessage.SmsProvider.CHUANGLAN)</span>
<span class="nc" id="L96">      .setProviderKey(arg.config.providerKey)</span>
<span class="nc" id="L97">      .setProviderValue(arg.config.providerValue.getOrElse(&quot;&quot;))</span>
<span class="nc" id="L98">      .setSendPath(sendPath)</span>
      .build()
  }

<span class="nc bnc" id="L102" title="All 56 branches missed.">  final case class Arguments(attrValues: Seq[Seq[String]], phoneNumbers: Seq[String],</span>
<span class="nc" id="L103">    shortMsg: ShortMessage, config: SmsConfig, baseMsg: SmsMessage.Builder)</span>

}

<span class="fc" id="L107">object SmsSendActor {</span>
<span class="fc" id="L108">  def props(injector: Injector): Props = Props[SmsSendActor](new SmsSendActor(injector))</span>
<span class="fc" id="L109">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
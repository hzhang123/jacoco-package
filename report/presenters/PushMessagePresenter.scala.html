<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PushMessagePresenter.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">presenters</a> &gt; <span class="el_source">PushMessagePresenter.scala</span></div><h1>PushMessagePresenter.scala</h1><pre class="source lang-java linenums">package presenters

import form.{ PushFilterForm, PushRuleTarget }
import io.growing.marketing.common.model.{ PushMessage, PushMetrics, PushRule }
import io.growing.micros.business.model.Status
import io.growing.micros.business.model.Status.Status
import io.growing.micros.utils.conversion.GrowingConversions._
import io.growing.micros.utils.time.DateTimeUtil.UTCNow
import org.joda.time.DateTime
import play.api.libs.json._
import utils.MappingUtil

/**
 * PushMessagePresenter
 *
 * @author damon lin
 *         2018/12/12
 */
<span class="nc bnc" id="L19" title="All 39 branches missed.">final case class PushMessagePresenter(</span>
<span class="nc" id="L20">  message: PushMessage,</span>
<span class="nc" id="L21">  rules: Seq[PushRule],</span>
<span class="nc" id="L22">  metrics: Option[PushMetrics],</span>
<span class="nc" id="L23">  audienceFilterForm: Option[PushFilterForm] = None)</span>

<span class="nc" id="L25">object PushMessagePresenter {</span>

<span class="nc" id="L27">  val mapping = Map(&quot;u&quot; -&gt; &quot;uv&quot;, &quot;cs1&quot; -&gt; &quot;usv&quot;)</span>
<span class="nc" id="L28">  val ABBREVIATION: String = &quot;var_&quot;</span>

<span class="nc" id="L30">  implicit object JodaDateTimeNumberWrites extends Writes[DateTime] {</span>
<span class="nc" id="L31">    def writes(d: DateTime): JsValue = JsNumber(d.getMillis)</span>
  }

<span class="nc" id="L34">  implicit val fmt = new Format[PushMessagePresenter] {</span>
    override def reads(json: JsValue): JsResult[PushMessagePresenter] = {
<span class="nc" id="L36">      JsError(&quot;Not implemented yet!&quot;)</span>
    }

    override def writes(o: PushMessagePresenter): JsValue = {
<span class="nc" id="L40">      val msg = o.message</span>
<span class="nc" id="L41">      val r = o.rules.headOption</span>
<span class="nc" id="L42">      val m = o.metrics</span>
<span class="nc" id="L43">      val f = o.audienceFilterForm</span>
<span class="nc" id="L44">      var base = Json.obj(</span>
<span class="nc" id="L45">        &quot;id&quot; -&gt; msg.dbid.toUid,</span>
<span class="nc" id="L46">        &quot;name&quot; -&gt; msg.name,</span>
<span class="nc" id="L47">        &quot;platform&quot; → msg.platform,</span>
<span class="nc" id="L48">        &quot;type&quot; -&gt; msg.`type`,</span>
<span class="nc" id="L49">        &quot;campaign&quot; -&gt; msg.campaign.toUid,</span>
<span class="nc" id="L50">        &quot;priority&quot; -&gt; msg.priority,</span>
<span class="nc" id="L51">        &quot;state&quot; -&gt; msg.state,</span>
<span class="nc" id="L52">        &quot;audienceType&quot; -&gt; msg.audienceType,</span>
<span class="nc" id="L53">        &quot;audienceId&quot; -&gt; MappingUtil.segmentIdMapping(msg.audienceId, mapping, id =&gt; id.toInt.toUid),</span>
<span class="nc" id="L54">        &quot;creator&quot; -&gt; msg.creatorId.toUid,</span>
<span class="nc" id="L55">        &quot;updater&quot; -&gt; msg.updaterId.toUid,</span>
<span class="nc" id="L56">        &quot;createdAt&quot; -&gt; msg.createdAt,</span>
<span class="nc" id="L57">        &quot;updateAt&quot; -&gt; msg.updatedAt)</span>
<span class="nc" id="L58">      val targets = o.rules.flatMap(PushRuleTarget.fromRule)</span>

<span class="nc" id="L60">      val wxQrCodeMap = o.rules.collect {</span>
<span class="nc bnc" id="L61" title="All 8 branches missed.">        case rule if rule.productId.nonEmpty &amp;&amp; rule.wxQrCode.nonEmpty =&gt;</span>
<span class="nc" id="L62">          rule.productId.get.toUid -&gt; rule.wxQrCode.get</span>
<span class="nc" id="L63">      }.toMap</span>

<span class="nc" id="L65">      r.foreach { rule ⇒</span>
<span class="nc" id="L66">        base ++= Json.obj(&quot;rule&quot; -&gt; Json.obj(</span>
<span class="nc" id="L67">          &quot;type&quot; -&gt; rule.`type`,</span>
<span class="nc" id="L68">          &quot;action&quot; -&gt; rule.action,</span>
<span class="nc" id="L69">          &quot;triggerFilter&quot; -&gt; rule.triggerFilter,</span>
<span class="nc" id="L70">          &quot;targets&quot; -&gt; targets,</span>
<span class="nc" id="L71">          &quot;limit&quot; -&gt; rule.limit,</span>
<span class="nc" id="L72">          &quot;activateAt&quot; -&gt; rule.activateAt,</span>
<span class="nc" id="L73">          &quot;productIds&quot; -&gt; o.rules.filter(_.productId.nonEmpty).map(_.productId.get.toUid),</span>
<span class="nc" id="L74">          &quot;triggerPages&quot; → o.rules.flatMap(_.triggerPages),</span>
<span class="nc" id="L75">          &quot;startAt&quot; → rule.startAt,</span>
<span class="nc" id="L76">          &quot;endAt&quot; → rule.endAt,</span>
<span class="nc" id="L77">          &quot;triggerDelay&quot; → rule.triggerDelay,</span>
<span class="nc" id="L78">          &quot;triggerCd&quot; → rule.triggerCd,</span>
<span class="nc" id="L79">          &quot;scheduleAt&quot; -&gt; rule.scheduleAt,</span>
<span class="nc" id="L80">          &quot;actionType&quot; -&gt; rule.actionType,</span>
<span class="nc" id="L81">          &quot;actionTarget&quot; -&gt; rule.actionTarget,</span>
<span class="nc" id="L82">          &quot;actionParameter&quot; -&gt; rule.actionParameters,</span>
<span class="nc" id="L83">          &quot;wxQrCode&quot; -&gt; Json.toJson(wxQrCodeMap)))</span>
      }

<span class="nc bnc" id="L86" title="All 2 branches missed.">      if (msg.contentMetadata.isDefined) {</span>
<span class="nc" id="L87">        base ++= Json.obj(</span>
<span class="nc" id="L88">          &quot;content&quot; -&gt; Json.toJson(msg.contentMetadata))</span>
      }
<span class="nc bnc" id="L90" title="All 2 branches missed.">      if (m.isDefined) {</span>
<span class="nc" id="L91">        base ++= Json.obj(</span>
<span class="nc" id="L92">          &quot;ctaMetrics&quot; -&gt; m.map(_.ctaClicks.map(_.toUid)),</span>
<span class="nc" id="L93">          &quot;messageImp&quot; -&gt; m.map(_.messageImp.map(_.toUid)),</span>
<span class="nc" id="L94">          &quot;messageClose&quot; -&gt; m.map(_.messageClose.map(_.toUid)),</span>
<span class="nc" id="L95">          &quot;messageSent&quot; -&gt; m.map(_.messageSent.map(_.toUid)))</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (m.flatMap(_.varKey).isDefined) {</span>
<span class="nc" id="L97">          var filter = Json.obj(</span>
<span class="nc" id="L98">            &quot;name&quot; -&gt; m.map(_.varName),</span>
<span class="nc" id="L99">            &quot;type&quot; -&gt; m.map(_.varType),</span>
<span class="nc" id="L100">            &quot;id&quot; -&gt; m.flatMap(_.varDBId.map(_.toUid)))</span>
<span class="nc" id="L101">          filter += (&quot;key&quot; -&gt; JsString(ABBREVIATION + m.flatMap(_.varKey).get))</span>
<span class="nc" id="L102">          base ++= Json.obj(&quot;filter&quot; -&gt; filter)</span>
        }
      }
<span class="nc bnc" id="L105" title="All 2 branches missed.">      if (f.isDefined) {</span>
<span class="nc" id="L106">        base ++= Json.obj(</span>
<span class="nc" id="L107">          &quot;audienceFilter&quot; -&gt; f.get)</span>
      }
<span class="nc" id="L109">      base</span>
    }
  }
}
<span class="nc" id="L113"></span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>